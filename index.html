<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Zyl0</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#000000; --ink:#f8fafc; --ink-soft:#d2d9e6; --muted:#9aa7bb;
      --field:rgba(14,18,26,.85); --field-focus:rgba(20,26,36,.92); --border:rgba(255,255,255,.12);
      --pill-bg:rgba(249,115,22,.18); --pill-ink:#ffd7a3; --btn:#f28a2d; --btn-ink:#1c130a;
      --ghost:rgba(255,255,255,.06); --ghost-border:rgba(255,255,255,.18);
      --ghost-hover-bg:rgba(255,255,255,.12); --ghost-active-bg:rgba(255,255,255,.18);
      --ghost-hover-border:rgba(255,255,255,.26); --ghost-active-border:rgba(255,255,255,.32);
      --ok:#4ade80; --warn:#fbbf24; --bad:#fb7185; --link:#7dd3fc;
      --success:#16f2a6; --danger:#f97373; --shadow:0 30px 60px rgba(3,6,10,.55);
      --toolbar-bg:rgba(6,9,15,.82);
      --input-bg:rgba(255,255,255,.05);
      --input-border:rgba(255,255,255,.14);
      --input-focus-border:rgba(125,211,252,.6);
      --input-focus-shadow:rgba(125,211,252,.2);
      --card-bg:rgba(255,255,255,.06);
      --table-card-bg:rgba(255,255,255,.05);
      --table-border:rgba(255,255,255,.08);
      --table-row-alt-bg:rgba(255,255,255,.03);
      --table-row-hover-bg:rgba(125,211,252,.12);
      --table-row-hover-shadow:inset 0 0 0 999px rgba(5,9,15,.12);
      --menu-bg:rgba(10,14,22,.96);
      --menu-hover-bg:rgba(255,255,255,.08);
      --modal-bg:rgba(10,14,22,.92);
      --backdrop-bg:rgba(3,6,11,.78);
      --chat-log-bg:rgba(255,255,255,.05);
      --ai-bubble-bg:rgba(15,20,28,.92);
      --ai-bubble-border:rgba(255,255,255,.12);
      --eye-bg:rgba(255,255,255,.08);
      --eye-border:rgba(255,255,255,.18);
      --addserv-bg:rgba(255,255,255,.04);
      --addserv-border:rgba(255,255,255,.26);
      --addserv-hover-bg:rgba(242,138,45,.16);
      --addserv-hover-border:rgba(242,138,45,.4);
      --addserv-active-bg:rgba(242,138,45,.24);
      --addserv-active-border:rgba(242,138,45,.5);
      --tag-border:rgba(255,255,255,.2);
      --tag-bg:rgba(255,255,255,.05);
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    html,body{margin:0;min-height:100%;background:var(--bg);color:var(--ink)}
    body{position:relative;min-height:100vh;overflow-x:hidden}
    body::before{content:"";position:fixed;inset:-40%;background:radial-gradient(circle at 20% 20%,rgba(242,138,45,.08),rgba(0,0,0,0) 45%),radial-gradient(circle at 80% 10%,rgba(125,211,252,.06),rgba(0,0,0,0) 52%),radial-gradient(circle at 30% 80%,rgba(22,242,166,.04),rgba(0,0,0,0) 55%);pointer-events:none;z-index:-1;filter:blur(0px)}
    body.theme-light{
      color-scheme:light;
      --bg:#f8fafc; --ink:#0f172a; --ink-soft:#1e293b; --muted:#475569;
      --field:#ffffff; --field-focus:#f1f5f9; --border:rgba(148,163,184,.35);
      --pill-bg:rgba(59,130,246,.14); --pill-ink:#1d4ed8;
      --ghost:rgba(226,232,240,.8); --ghost-border:rgba(148,163,184,.6);
      --ghost-hover-bg:rgba(148,163,184,.28); --ghost-active-bg:rgba(148,163,184,.36);
      --ghost-hover-border:rgba(100,116,139,.6); --ghost-active-border:rgba(71,85,105,.6);
      --shadow:0 18px 40px rgba(15,23,42,.12);
      --toolbar-bg:rgba(255,255,255,.86);
      --input-bg:#ffffff;
      --input-border:rgba(148,163,184,.55);
      --input-focus-border:rgba(37,99,235,.5);
      --input-focus-shadow:rgba(37,99,235,.18);
      --card-bg:#ffffff;
      --table-card-bg:#ffffff;
      --table-border:rgba(226,232,240,.9);
      --table-row-alt-bg:rgba(226,232,240,.6);
      --table-row-hover-bg:rgba(59,130,246,.12);
      --table-row-hover-shadow:inset 0 0 0 999px rgba(15,23,42,.08);
      --menu-bg:#ffffff;
      --menu-hover-bg:rgba(226,232,240,.9);
      --modal-bg:#ffffff;
      --backdrop-bg:rgba(15,23,42,.35);
      --chat-log-bg:#f8fafc;
      --ai-bubble-bg:#e2e8f0;
      --ai-bubble-border:rgba(148,163,184,.4);
      --eye-bg:#e2e8f0;
      --eye-border:rgba(148,163,184,.7);
      --addserv-bg:#e2e8f0;
      --addserv-border:rgba(148,163,184,.6);
      --addserv-hover-bg:rgba(59,130,246,.15);
      --addserv-hover-border:rgba(59,130,246,.45);
      --addserv-active-bg:rgba(59,130,246,.22);
      --addserv-active-border:rgba(37,99,235,.6);
      --tag-border:rgba(148,163,184,.6);
      --tag-bg:#e2e8f0;
    }
    body.theme-light::before{
      background:radial-gradient(circle at 20% 20%,rgba(59,130,246,.15),rgba(148,163,184,0) 45%),
                 radial-gradient(circle at 80% 10%,rgba(16,185,129,.12),rgba(148,163,184,0) 52%),
                 radial-gradient(circle at 30% 80%,rgba(249,115,22,.12),rgba(148,163,184,0) 55%);
    }
    a{color:inherit}

    /* ===== Toolbar superior ===== */
    .toolbar{position:sticky;top:0;z-index:40;background:rgba(6,9,15,.82);backdrop-filter:saturate(160%) blur(16px);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
    .toolbar-inner{max-width:980px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .toolbar input,.toolbar select{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.05);color:var(--ink);min-width:200px;box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
    .toolbar input::placeholder{color:var(--muted)}
    .toolbar select{color:var(--ink)}
    .toolbar select option{color:#0f172a;background:#e2e8f0}
    .spacer{flex:1}
    .btn{border:0;border-radius:14px;padding:10px 16px;cursor:pointer;font-weight:600;transition:background-color .2s ease,border-color .2s ease,box-shadow .2s ease,transform .2s ease,color .2s ease;color:var(--ink)}
    .btn.ghost{background:var(--ghost);border:1px solid var(--ghost-border);box-shadow:inset 0 1px 0 rgba(255,255,255,.05)}
    .btn.primary{background:var(--btn);color:var(--btn-ink);box-shadow:0 12px 24px rgba(242,138,45,.35)}
    .btn:hover,.btn:focus-visible{box-shadow:0 14px 28px rgba(5,9,15,.45);transform:translateY(-1px)}
    .btn:active{transform:translateY(0);box-shadow:0 6px 12px rgba(5,9,15,.6)}
    .btn.ghost:hover,.btn.ghost:focus-visible{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.26)}
    .btn.ghost:active{background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.32)}
    .btn.primary:hover,.btn.primary:focus-visible{background:#ffa24d}
    .btn.primary:active{background:#f28a2d}
    .btn:focus-visible{outline:2px solid rgba(125,211,252,.45);outline-offset:3px}
    .linklike{background:none;border:0;color:var(--link);cursor:pointer;padding:0;font-weight:600;position:relative;transition:color .2s ease}
    .linklike::after{content:"";position:absolute;left:0;bottom:-2px;width:100%;height:2px;background:currentColor;transform:scaleX(0);transform-origin:left;transition:transform .2s ease}
    .linklike:hover,.linklike:focus-visible{color:#bae6fd}
    .linklike:hover::after,.linklike:focus-visible::after{transform:scaleX(1)}
    .linklike:active{color:#38bdf8}
    .linklike:active::after{transform:scaleX(1)}

    /* ===== Layout ===== */
    .wrap{width:min(1200px,92vw);margin:0 auto;padding:36px 18px 80px;position:relative;z-index:0}
    .pill{display:block;width:max-content;margin:0 auto 14px;padding:6px 14px;border-radius:999px;background:var(--pill-bg);color:var(--pill-ink);border:1px solid rgba(255,255,255,.24);font-size:12px;letter-spacing:.08em;text-transform:uppercase}
    h1{margin:6px 0 20px;text-align:center;font-weight:800;letter-spacing:-0.02em;color:var(--ink);font-size:clamp(72px,16vw,144px);line-height:1.02;text-shadow:0 12px 32px rgba(0,0,0,.55)}

    /* ===== Servicio centrado ===== */
    .center{display:flex;justify-content:center;align-items:center;gap:10px;margin:8px 0 20px}
    .center .label{color:var(--ink-soft)}
    .addserv{border:1px dashed rgba(255,255,255,.26);background:rgba(255,255,255,.04);color:var(--ink);padding:8px 12px;border-radius:12px;font-size:15px;min-width:40px;text-align:center;transition:background-color .2s ease,border-color .2s ease,box-shadow .2s ease,transform .2s ease,color .2s ease}
    .addserv:hover,.addserv:focus-visible{background:rgba(242,138,45,.16);border-color:rgba(242,138,45,.4);box-shadow:0 10px 24px rgba(5,9,15,.4);transform:translateY(-1px)}
    .addserv:active{background:rgba(242,138,45,.24);border-color:rgba(242,138,45,.5);transform:translateY(0);box-shadow:0 6px 16px rgba(5,9,15,.6)}
    .addserv:focus-visible{outline:2px solid rgba(242,138,45,.35);outline-offset:2px}
    .addserv.remove{border-color:rgba(251,113,133,.45);color:#fecdd3;background:rgba(248,113,113,.16)}

    /* ===== Form (labels arriba) ===== */
    .content-grid{display:grid;gap:24px;margin-top:32px}
    @media(min-width:960px){
      .content-grid{grid-template-columns:minmax(0,2fr)minmax(0,1fr)}
    }
    .form{background:rgba(255,255,255,.06);border-radius:20px;border:1px solid var(--border);padding:28px;box-shadow:var(--shadow);backdrop-filter:blur(22px)}
    .form-grid{display:grid;gap:16px}
    @media(min-width:720px){
      .form-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    .row{display:flex;flex-direction:column;gap:6px}
    .form-grid .row{min-width:0}
    .span-2{grid-column:1 / -1}
    .row label{color:var(--ink-soft);font-size:13px;font-weight:600;letter-spacing:.04em;text-transform:uppercase}
    input,select,textarea{width:100%;padding:14px;border:1px solid rgba(255,255,255,.14);border-radius:14px;background:var(--field);color:var(--ink);outline:none;transition:.15s;box-shadow:inset 0 1px 0 rgba(255,255,255,.06)}
    input::placeholder,textarea::placeholder{color:var(--muted)}
    input:focus,select:focus,textarea:focus{border-color:rgba(125,211,252,.6);background:var(--field-focus);box-shadow:0 0 0 3px rgba(125,211,252,.2)}
    textarea{min-height:88px;resize:vertical}
    .actions{display:flex;justify-content:center;gap:10px;margin-top:18px}
    .small{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
    .side-card{background:rgba(255,255,255,.06);border-radius:20px;border:1px solid var(--border);padding:28px;box-shadow:var(--shadow);backdrop-filter:blur(22px);display:flex;flex-direction:column;gap:18px}
    .side-card h2{margin:0;font-size:18px;color:var(--ink);font-weight:700}
    .side-card p{margin:0;color:var(--muted);font-size:14px}
    .side-card .actions{flex-direction:column;justify-content:flex-start}
    .side-card .actions .btn{width:100%}
    .side-card .small{text-align:left;margin-top:0}
    .pin-wrap{position:relative}
    .pin-wrap .eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:var(--ink);border-radius:10px;padding:6px 8px;cursor:pointer;transition:background-color .2s ease,border-color .2s ease}
    .pin-wrap .eye:hover,.pin-wrap .eye:focus-visible{background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.28)}
    .pin-wrap .eye:focus-visible{outline:2px solid rgba(125,211,252,.35);outline-offset:2px}

    /* ===== Tabla ===== */
    .table-section{margin-top:40px;display:flex;flex-direction:column;gap:18px}
    .table-header{display:flex;flex-direction:column;gap:6px}
    @media(min-width:720px){
      .table-header{flex-direction:row;align-items:flex-end;justify-content:space-between}
    }
    .table-header h2{margin:0;font-size:22px;font-weight:700;color:var(--ink);text-shadow:0 10px 20px rgba(0,0,0,.35)}
    .table-header p{margin:0;color:var(--muted);font-size:14px}
    .table-card{position:relative;background:rgba(255,255,255,.05);border-radius:20px;border:1px solid var(--border);box-shadow:var(--shadow);overflow:visible;backdrop-filter:blur(18px)}
    table{width:100%;border-collapse:separate;border-spacing:0;border-radius:inherit}
    th,td{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);font-size:14px}
    th{text-align:left;color:var(--muted);font-weight:700;letter-spacing:.08em;font-size:12px;text-transform:uppercase}
    td{color:var(--ink);font-weight:500}
    tbody tr{transition:background-color .2s ease,box-shadow .2s ease}
    tbody tr:nth-child(even){background:rgba(255,255,255,.03)}
    tbody tr:hover{background:rgba(125,211,252,.12);box-shadow:inset 0 0 0 999px rgba(5,9,15,.12)}
    thead th:first-child{border-top-left-radius:20px}
    thead th:last-child{border-top-right-radius:20px}
    tbody tr:last-child td:first-child{border-bottom-left-radius:20px}
    tbody tr:last-child td:last-child{border-bottom-right-radius:20px}
    .table-card th,.table-card td{background-clip:padding-box}
    .tag{font-size:12px;padding:4px 10px;border-radius:999px;display:inline-block;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);color:var(--ink);backdrop-filter:blur(12px)}
    .tag.ok{color:var(--ok);background:rgba(74,222,128,.16);border-color:rgba(74,222,128,.38)}
    .tag.warn{color:var(--warn);background:rgba(251,191,36,.16);border-color:rgba(251,191,36,.38)}
    .tag.bad{color:var(--bad);background:rgba(251,113,133,.2);border-color:rgba(251,113,133,.4)}

    /* ===== Kebab ⋯ menú ===== */
    .menu-wrap{position:relative;display:inline-block}
    .kebab{border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);border-radius:12px;padding:6px 10px;cursor:pointer;line-height:1;color:var(--ink);transition:background-color .2s ease,border-color .2s ease}
    .kebab .dots{letter-spacing:2px;font-size:18px;color:var(--ink-soft)}
    .kebab:focus{outline:2px solid rgba(125,211,252,.35)}
    .kebab:hover{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.28)}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:rgba(10,14,22,.96);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);min-width:180px;padding:8px;opacity:0;visibility:hidden;pointer-events:none;transform:translateY(-6px);transition:opacity .2s ease,transform .2s ease;z-index:50;backdrop-filter:blur(18px)}
    .menu.open{opacity:1;visibility:visible;pointer-events:auto;transform:translateY(0)}
    .menu-item{display:block;width:100%;text-align:left;background:transparent;border:1px solid transparent;border-radius:10px;padding:10px 12px;cursor:pointer;font-size:14px;color:var(--ink);transition:background-color .15s ease,border-color .15s ease,color .15s ease}
    .menu-item:hover{background:rgba(255,255,255,.08)}
    .menu-item.danger{color:var(--bad);border:1px solid rgba(251,113,133,.35);background:rgba(251,113,133,.12)}
    .menu-item.danger:hover{background:rgba(251,113,133,.2);border-color:rgba(251,113,133,.5)}

    /* ===== Modales ===== */
    .modal-backdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;background:rgba(3,6,11,.78);opacity:0;visibility:hidden;pointer-events:none;transform:translateY(6px);transition:opacity .2s ease,transform .2s ease;z-index:100;backdrop-filter:blur(12px)}
    .modal-backdrop.open{opacity:1;visibility:visible;pointer-events:auto;transform:translateY(0)}
    .modal{background:rgba(10,14,22,.92);border:1px solid var(--border);border-radius:18px;width:min(760px,96vw);max-height:90vh;display:flex;flex-direction:column;box-shadow:var(--shadow);color:var(--ink);backdrop-filter:blur(22px)}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
    .modal .body{padding:16px 18px;color:var(--ink)}

    /* ===== Chat (Gemini) ===== */
    .section-head{font-weight:700;margin-bottom:8px;color:var(--ink);text-shadow:0 10px 24px rgba(0,0,0,.45)}
    .chat-log{height:260px;overflow:auto;border:1px solid var(--border);border-radius:16px;padding:14px;background:var(--chat-log-bg);box-shadow:inset 0 1px 0 rgba(255,255,255,.04);backdrop-filter:blur(14px)}
    .chat-msg{margin:8px 0;display:flex}
    .chat-msg.user{justify-content:flex-end}
    .chat-msg .bubble{max-width:85%;padding:10px 12px;border-radius:12px;white-space:pre-wrap}
    .chat-msg.user .bubble{background:linear-gradient(135deg,#f28a2d,#f59e0b);color:#1a1205;border:1px solid rgba(255,255,255,.18);box-shadow:0 14px 32px rgba(242,138,45,.35)}
    .chat-msg.ai .bubble{background:var(--ai-bubble-bg);border:1px solid var(--ai-bubble-border);color:var(--ink);box-shadow:0 10px 24px rgba(0,0,0,.4)}

    /* ===== Tokens de tema ===== */
    .toolbar{background:var(--toolbar-bg);position:sticky;top:0;z-index:20;display:flex;align-items:center;padding:8px 12px}
    .menu-toggle{background:transparent;border:none;font-size:24px;color:var(--ink);cursor:pointer;display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:8px;transition:background .2s ease}
    .menu-toggle:hover,.menu-toggle:focus-visible{background:rgba(255,255,255,.08)}
    .menu-toggle.close{position:absolute;top:12px;right:12px;font-size:22px}
    .sidebar{position:fixed;inset:0 auto 0 0;width:280px;max-width:80vw;background:var(--card-bg);box-shadow:20px 0 40px rgba(0,0,0,.35);transform:translateX(-110%);transition:transform .3s ease;z-index:40;padding:60px 20px 20px;display:flex;flex-direction:column}
    .sidebar.open,.sidebar[aria-hidden="false"]{transform:translateX(0)}
    .sidebar-content{position:relative;height:100%;overflow-y:auto}
      .sidebar-nav{display:grid;gap:14px}
      .nav-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:14px;border:1px solid var(--ghost-border);background:var(--ghost);color:var(--ink);cursor:pointer;transition:background .2s ease,border-color .2s ease,transform .2s ease;position:relative;text-align:left}
      .nav-item .icon{display:inline-flex;width:22px;height:22px;align-items:center;justify-content:center;color:currentColor}
      .nav-item .icon svg{width:100%;height:100%}
      .nav-item .label{font-weight:600;letter-spacing:.01em}
      .nav-item .tooltip{position:absolute;top:50%;left:calc(100% + 10px);transform:translateY(-50%);background:var(--ghost);border:1px solid var(--ghost-border);border-radius:10px;padding:6px 10px;font-size:12px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .2s ease,transform .2s ease;box-shadow:0 10px 20px rgba(5,9,15,.35)}
      .nav-item:focus-visible,.nav-item:hover{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border);transform:translateX(2px)}
      .nav-item:focus-visible{outline:2px solid rgba(125,211,252,.45);outline-offset:3px}
      .sidebar[data-collapsed="true"] .nav-item{justify-content:center}
      .sidebar[data-collapsed="true"] .nav-item .label{position:absolute;clip:rect(0 0 0 0);width:1px;height:1px;margin:-1px;border:0;padding:0;overflow:hidden}
      .sidebar[data-collapsed="true"] .nav-item .tooltip{display:block;pointer-events:auto;opacity:0}
      .sidebar[data-collapsed="true"] .nav-item:focus-visible .tooltip,
      .sidebar[data-collapsed="true"] .nav-item:hover .tooltip{opacity:1;transform:translate(6px,-50%)}
      .sidebar input,.sidebar select{border:1px solid var(--input-border);background:var(--input-bg);color:var(--ink)}
    .sidebar-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .3s ease;z-index:30}
    .sidebar-backdrop.visible{opacity:1;pointer-events:auto}
    .btn.ghost:hover,.btn.ghost:focus-visible{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border)}
    .btn.ghost:active{background:var(--ghost-active-bg);border-color:var(--ghost-active-border)}
    .pill{border:1px solid var(--border)}
    .addserv{border:1px dashed var(--addserv-border);background:var(--addserv-bg)}
    .addserv:hover,.addserv:focus-visible{background:var(--addserv-hover-bg);border-color:var(--addserv-hover-border)}
    .addserv:active{background:var(--addserv-active-bg);border-color:var(--addserv-active-border)}
    .form,.side-card{background:var(--card-bg)}
    input,select,textarea{border:1px solid var(--input-border);background:var(--field)}
    input:focus,select:focus,textarea:focus{border-color:var(--input-focus-border);background:var(--field-focus);box-shadow:0 0 0 3px var(--input-focus-shadow)}
    .pin-wrap .eye{border:1px solid var(--eye-border);background:var(--eye-bg)}
    .pin-wrap .eye:hover,.pin-wrap .eye:focus-visible{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border)}
    .table-card{background:var(--table-card-bg)}
    th,td{border-bottom:1px solid var(--table-border)}
    tbody tr:nth-child(even){background:var(--table-row-alt-bg)}
    tbody tr:hover{background:var(--table-row-hover-bg);box-shadow:var(--table-row-hover-shadow)}
    .tag{border:1px solid var(--tag-border);background:var(--tag-bg)}
    .menu{background:var(--menu-bg)}
    .menu-item:hover{background:var(--menu-hover-bg)}
      .menu-item[aria-checked="true"]{background:var(--ghost);border:1px solid var(--ghost-border);font-weight:600}
      #overlay{position:fixed;inset:0;background:var(--backdrop-bg);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:120}
      #overlay.visible{opacity:1;pointer-events:auto}
      #modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:20px;pointer-events:none;opacity:0;transition:opacity .2s ease;z-index:130}
      #modal.open{opacity:1;pointer-events:auto}
      #modal .modal-dialog{background:var(--modal-bg);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);width:min(640px,94vw);max-height:90vh;display:flex;flex-direction:column;overflow:hidden}
      #modal header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.1)}
      #modal header h2{margin:0;font-size:18px;font-weight:700;color:var(--ink)}
      #modal .modal-body{padding:18px 20px;overflow-y:auto;color:var(--ink)}
      .modal-close{background:var(--ghost);border:1px solid var(--ghost-border);border-radius:10px;padding:6px 10px;color:var(--ink);cursor:pointer;font-weight:600;transition:background .2s ease,border-color .2s ease}
      .modal-close:hover,.modal-close:focus-visible{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border)}
      .field{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}
      .field label{font-size:13px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
      .modal-body .field:last-child{margin-bottom:0}
      .status-cards{display:grid;gap:12px;margin:16px 0}
      @media(min-width:520px){ .status-cards{grid-template-columns:repeat(2,minmax(0,1fr));} }
      .status-card{padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:var(--card-bg);box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
      .status-card strong{display:block;font-size:20px;font-weight:700;color:var(--ink)}
      .status-card span{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
      .theme-options{display:grid;gap:12px;margin-top:12px}
      .theme-option{display:flex;align-items:flex-start;gap:12px;padding:12px 14px;border:1px solid var(--border);border-radius:14px;background:var(--card-bg);cursor:pointer;transition:border-color .2s ease,background .2s ease}
      .theme-option:hover,.theme-option:focus-within{border-color:var(--ghost-hover-border);background:var(--ghost-hover-bg)}
      .theme-option input{margin-top:4px}
      .theme-option strong{font-size:15px;font-weight:700;color:var(--ink)}
      .theme-option span{font-size:13px;color:var(--muted)}
      .account-form{display:flex;flex-direction:column;gap:16px}
      .account-form .actions{margin-top:0}
      .chat-controls{display:grid;grid-template-columns:1fr auto;gap:8px;margin:14px 0}
      .chat-controls textarea{min-height:90px;resize:vertical}

    @media (max-width:680px){ .sidebar{width:240px} }
  </style>
</head>
<body>
  <!-- toolbar -->
  <div class="toolbar">
    <button class="menu-toggle" id="btnMenuToggle" aria-expanded="false" aria-controls="sidebar" aria-label="Abrir menú">☰</button>
  </div>

  <aside class="sidebar" id="sidebar" aria-hidden="true">
    <div class="sidebar-content">
      <button class="menu-toggle close" id="btnMenuClose" aria-label="Cerrar menú">×</button>
      <nav aria-label="Controles principales">
        <div class="sidebar-nav" id="primaryNav" data-nav>
          <button type="button" class="nav-item" data-action="search" aria-label="Buscar" aria-describedby="tip-search">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="6"></circle>
                <line x1="20" y1="20" x2="16.65" y2="16.65"></line>
              </svg>
            </span>
            <span class="label">Buscar</span>
            <span class="tooltip" role="tooltip" id="tip-search">Buscar</span>
          </button>
          <button type="button" class="nav-item" data-action="status" aria-label="Panel de estado" aria-describedby="tip-status">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 19h16"></path>
                <path d="M7 16v-6"></path>
                <path d="M12 16V8"></path>
                <path d="M17 16v-4"></path>
              </svg>
            </span>
            <span class="label">Estado</span>
            <span class="tooltip" role="tooltip" id="tip-status">Panel de estado</span>
          </button>
          <button type="button" class="nav-item" data-action="theme" aria-label="Cambiar tema" aria-describedby="tip-theme">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </span>
            <span class="label"><span id="navThemeLabel">Tema</span></span>
            <span class="tooltip" role="tooltip" id="tip-theme">Cambiar tema</span>
          </button>
          <button type="button" class="nav-item" data-action="account" aria-label="Cuenta" aria-describedby="tip-account">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </span>
            <span class="label"><span id="navAccountLabel">Cuenta</span></span>
            <span class="tooltip" role="tooltip" id="tip-account">Cuenta</span>
          </button>
          <button type="button" class="nav-item" data-action="chat" aria-label="Asistente IA" aria-describedby="tip-chat">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
              </svg>
            </span>
            <span class="label">Chat IA</span>
            <span class="tooltip" role="tooltip" id="tip-chat">Asistente IA</span>
          </button>
        </div>
      </nav>
    </div>
  </aside>
  <div class="sidebar-backdrop" id="sidebarBackdrop" hidden></div>

  <div class="wrap">
    <span class="pill">importante</span>
    <h1>SUPERZYLO</h1>

    <div class="center">
      <div class="label">Servicio</div>
      <select id="servicio" style="max-width:260px"></select>
      <button id="btnAgregarServicio" class="addserv" aria-label="Agregar servicio" title="Agregar servicio">+</button>
      <button id="btnEliminarServicio" class="addserv remove" aria-label="Eliminar servicio" title="Eliminar servicio">−</button>
    </div>

    <div class="content-grid">
      <div class="form">
        <div class="form-grid">
          <div class="row">
            <label for="nombre">Nombre</label>
            <input id="nombre" placeholder="Escribe"/>
          </div>
          <div class="row">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="ej: cliente@mail.com"/>
          </div>
          <div class="row">
            <label for="telefono">Teléfono</label>
            <input id="telefono" placeholder="+51 …"/>
          </div>
          <div class="row">
            <label for="inicio">Fecha</label>
            <input id="inicio" type="date" />
          </div>
          <div class="row">
            <label for="vence">Vence</label>
            <input id="vence" type="date" />
          </div>
          <div class="row">
            <label for="pin">PIN</label>
            <div class="pin-wrap">
              <input id="pin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="••••" />
              <button type="button" class="eye" id="togglePin" aria-label="Mostrar/ocultar PIN">👁</button>
            </div>
          </div>
          <div class="row">
            <label for="categoria">Categoría</label>
            <select id="categoria">
              <option value="">Selecciona una opción</option>
              <option>Premium</option>
              <option>Estándar</option>
              <option>Básico</option>
            </select>
          </div>
          <div class="row span-2">
            <label for="notas">Notas</label>
            <textarea id="notas" placeholder="Plan, precio, usuario, etc."></textarea>
          </div>
        </div>
      </div>
      <aside class="side-card">
        <h2>Acciones rápidas</h2>
        <p>Guarda el nuevo cliente o limpia el formulario antes de continuar.</p>
        <div class="actions">
          <button class="btn primary" id="btnGuardar">Agregar</button>
          <button class="btn ghost" id="btnLimpiar">Limpiar</button>
        </div>
        <div class="small" id="msg"></div>
      </aside>
    </div>

    <!-- tabla -->
    <section class="table-section">
      <div class="table-header">
        <h2>Clientes registrados</h2>
        <p>Consulta el listado completo y gestiona cada registro.</p>
      </div>
      <div class="table-card">
        <table id="tabla">
          <thead>
            <tr>
              <th>Nombre</th><th>Email</th><th>Servicio</th>
              <th>Inicio</th><th>Vence</th><th>Estado</th><th>Días</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="overlay" hidden></div>
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" hidden>
    <div class="modal-dialog">
      <header>
        <h2 id="modalTitle"></h2>
        <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">Cerrar</button>
      </header>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* ====== CONFIG Supabase ====== */
const SUPABASE_URL = 'https://sevhzvoibsuqcjroefgb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNldmh6dm9pYnN1cWNqcm9lZmdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MzUxMzQsImV4cCI6MjA3NDAxMTEzNH0.whFwTL-5UuwwpsZBzs7auzMm8t2mvZ1ldndPkstDDDE';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== helpers y refs ===== */
const $=s=>document.querySelector(s);
const tbody=$('#tabla tbody');
const f={nombre:$('#nombre'),email:$('#email'),telefono:$('#telefono'),
servicio:$('#servicio'),inicio:$('#inicio'),vence:$('#vence'),notas:$('#notas'),
categoria:$('#categoria'), pin:$('#pin')};
const msg=$('#msg');
const sidebar=document.getElementById('sidebar');
const sidebarToggle=document.getElementById('btnMenuToggle');
const sidebarClose=document.getElementById('btnMenuClose');
const sidebarBackdrop=document.getElementById('sidebarBackdrop');
const nav=document.getElementById('primaryNav');
const navThemeLabel=document.getElementById('navThemeLabel');
const navAccountLabel=document.getElementById('navAccountLabel');
const themeNavButton=nav?.querySelector('[data-action="theme"]');
const accountNavButton=nav?.querySelector('[data-action="account"]');
const overlay=document.getElementById('overlay');
const modal=document.getElementById('modal');
const modalTitle=document.getElementById('modalTitle');
const modalBody=document.getElementById('modalBody');
const modalCloseButton=modal?.querySelector('[data-modal-close]');
const THEME_STORAGE_KEY='ui_theme_mode_v1';
let editId=null;
let activeTrigger=null;
let modalCleanup=null;
let currentModalAction=null;
let searchTerm='';
let estadoFiltro='';
let accountModalUpdater=null;
let chatUIRefs=null;

function openSidebar(){
  if(!sidebar) return;
  sidebar.classList.add('open');
  sidebar.setAttribute('aria-hidden','false');
  sidebarToggle?.setAttribute('aria-expanded','true');
  sidebarBackdrop?.classList.add('visible');
  sidebarBackdrop?.removeAttribute('hidden');
}

function closeSidebar(){
  if(!sidebar) return;
  sidebar.classList.remove('open');
  sidebar.setAttribute('aria-hidden','true');
  sidebarToggle?.setAttribute('aria-expanded','false');
  sidebarBackdrop?.classList.remove('visible');
  sidebarBackdrop?.setAttribute('hidden','');
}

function toggleSidebar(){
  if(sidebar?.classList.contains('open')) closeSidebar();
  else openSidebar();
}

function toast(t){ msg.textContent=t; setTimeout(()=>msg.textContent='',2200); }
function esc(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;' }[m]))}
function fmt(iso){return iso? new Date(iso+'T00:00:00').toLocaleDateString(): '-'}

function getFocusable(container){
  return Array.from(container.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'))
    .filter(el=>!el.hasAttribute('disabled') && el.getAttribute('aria-hidden')!=='true');
}

function focusFirst(container){
  const nodes=getFocusable(container);
  if(nodes.length){ nodes[0].focus(); }
  else modalCloseButton?.focus();
}

function closeModal({restoreFocus=true}={}){
  if(!modal?.classList.contains('open')) return;
  modal.classList.remove('open');
  modal.setAttribute('hidden','');
  overlay?.classList.remove('visible');
  overlay?.setAttribute('hidden','');
  if(typeof modalCleanup==='function'){ try{ modalCleanup(); }catch(err){ console.warn('Error al cerrar modal', err); } }
  modalCleanup=null;
  accountModalUpdater=null;
  chatUIRefs=null;
  currentModalAction=null;
  const trigger=activeTrigger;
  activeTrigger=null;
  modalBody.innerHTML='';
  if(restoreFocus && trigger){ try{ trigger.focus(); }catch{} }
}

function openModalFor(action, trigger){
  if(!modal || !overlay) return;
  const builder = modalBuilders[action];
  if(typeof builder!=='function') return;
  closeModal({restoreFocus:false});
  const result = builder();
  if(!result) return;
  const { title, content, onOpen, onClose } = result;
  modalTitle.textContent = title || '';
  modalBody.innerHTML='';
  if(typeof content==='string') modalBody.innerHTML = content;
  else if(content instanceof Node) modalBody.append(content);
  else if(Array.isArray(content)) content.forEach(node=>{ if(node instanceof Node) modalBody.append(node); });
  modalCleanup = typeof onClose==='function'? onClose : null;
  activeTrigger = trigger || null;
  currentModalAction = action;
  overlay.classList.add('visible');
  overlay.removeAttribute('hidden');
  modal.classList.add('open');
  modal.removeAttribute('hidden');
  requestAnimationFrame(()=>{
    focusFirst(modalBody);
    if(typeof onOpen==='function') onOpen();
  });
}

function buildSearchModal(){
  const wrapper=document.createElement('div');
  const field=document.createElement('div');
  field.className='field';
  const label=document.createElement('label');
  label.setAttribute('for','modalSearchInput');
  label.textContent='Buscar en clientes';
  const input=document.createElement('input');
  input.id='modalSearchInput';
  input.type='search';
  input.placeholder='Nombre, email o servicio';
  input.autocomplete='off';
  input.value=searchTerm;
  const hint=document.createElement('p');
  hint.className='small';
  const actions=document.createElement('div');
  actions.className='actions';
  actions.style.justifyContent='flex-end';
  const clearBtn=document.createElement('button');
  clearBtn.type='button';
  clearBtn.className='btn ghost';
  clearBtn.textContent='Limpiar búsqueda';
  actions.append(clearBtn);
  field.append(label,input);
  wrapper.append(field,hint,actions);

  const estadoLabels={vigente:'vigentes',pronto:'por vencer',vencida:'vencidas'};
  function updateHint(){
    const arr=db.getAll();
    const filtered=arr.filter(x=>coincide(x,searchTerm)&&pasaEstado(x,estadoFiltro));
    const estadoTxt=estadoFiltro?` con estado ${estadoLabels[estadoFiltro]||estadoFiltro}`:'';
    if(searchTerm){
      hint.textContent=`${filtered.length} resultado${filtered.length===1?'':'s'} coinciden con "${searchTerm}"${estadoTxt}.`;
    }else{
      hint.textContent=`${filtered.length} de ${arr.length} registros visibles${estadoTxt}.`;
    }
    clearBtn.disabled=!searchTerm;
  }

  input.addEventListener('input',e=>{
    searchTerm=e.target.value;
    renderTabla().then(updateHint).catch(()=>updateHint());
  });

  clearBtn.addEventListener('click',()=>{
    if(!searchTerm) return;
    searchTerm='';
    input.value='';
    renderTabla().then(updateHint).catch(()=>updateHint());
    input.focus();
  });

  updateHint();

  return {
    title:'Buscar',
    content:wrapper,
    onOpen(){ setTimeout(()=>{ input.focus(); input.select(); },50); }
  };
}

function buildStatusModal(){
  const wrapper=document.createElement('div');
  const description=document.createElement('p');
  description.className='small';
  description.textContent='Consulta el resumen de clientes y aplica un filtro rápido por estado.';
  const field=document.createElement('div');
  field.className='field';
  const label=document.createElement('label');
  label.setAttribute('for','modalEstadoSelect');
  label.textContent='Filtrar por estado';
  const select=document.createElement('select');
  select.id='modalEstadoSelect';
  [['','Todos'],['vigente','Vigentes'],['pronto','Por vencer (≤7 días)'],['vencida','Vencidas']]
    .forEach(([value,text])=>{
      const option=document.createElement('option');
      option.value=value;
      option.textContent=text;
      select.append(option);
    });
  select.value=estadoFiltro||'';
  field.append(label,select);
  const cards=document.createElement('div');
  cards.className='status-cards';
  const summary=document.createElement('p');
  summary.className='small';

  const estadoLabels={vigente:'vigentes',pronto:'por vencer',vencida:'vencidas'};
  function makeCard(labelText,value){
    const card=document.createElement('div');
    card.className='status-card';
    const strong=document.createElement('strong');
    strong.textContent=String(value);
    const span=document.createElement('span');
    span.textContent=labelText;
    card.append(strong,span);
    return card;
  }

  function updateSummary(){
    const arr=db.getAll();
    const counts={total:arr.length,vigente:0,pronto:0,vencida:0};
    arr.forEach(item=>{ const est=estadoDe(item.vence); if(est&&counts[est]!==undefined) counts[est]++; });
    cards.innerHTML='';
    cards.append(
      makeCard('Total',counts.total),
      makeCard('Vigentes',counts.vigente),
      makeCard('Por vencer',counts.pronto),
      makeCard('Vencidas',counts.vencida)
    );
    const visibles=arr.filter(x=>coincide(x,searchTerm)&&pasaEstado(x,estadoFiltro)).length;
    summary.textContent = estadoFiltro
      ? `Filtro aplicado: ${estadoLabels[estadoFiltro]||estadoFiltro}. Resultados visibles: ${visibles}.`
      : `Resultados visibles: ${visibles} (sin filtro por estado).`;
  }

  select.addEventListener('change',e=>{
    estadoFiltro=e.target.value;
    renderTabla().then(updateSummary).catch(()=>updateSummary());
  });

  updateSummary();

  wrapper.append(description,field,cards,summary);
  return {
    title:'Panel de estado',
    content:wrapper,
    onOpen(){ select.focus(); }
  };
}

function buildThemeModal(){
  const wrapper=document.createElement('div');
  const description=document.createElement('p');
  description.className='small';
  description.textContent='Elige el modo que prefieras. Guardamos tu selección en este dispositivo.';
  const options=document.createElement('div');
  options.className='theme-options';
  const current=document.body.classList.contains('theme-light')?'light':'dark';
  const choices=[
    {value:'dark',label:'Oscuro',detail:'Mejor contraste en ambientes tenues.'},
    {value:'light',label:'Claro',detail:'Ideal para espacios iluminados.'}
  ];
  choices.forEach(opt=>{
    const item=document.createElement('label');
    item.className='theme-option';
    const radio=document.createElement('input');
    radio.type='radio';
    radio.name='themeOption';
    radio.value=opt.value;
    radio.checked=opt.value===current;
    const title=document.createElement('strong');
    title.textContent=opt.label;
    const detail=document.createElement('span');
    detail.textContent=opt.detail;
    item.append(radio,title,detail);
    options.append(item);
  });
  options.addEventListener('change',e=>{
    if(e.target && e.target.name==='themeOption'){
      applyTheme(e.target.value);
    }
  });
  wrapper.append(description,options);
  return {
    title:'Cambiar tema',
    content:wrapper,
    onOpen(){ const checked=options.querySelector('input:checked'); if(checked) checked.focus(); }
  };
}

function buildAccountModal(){
  const container=document.createElement('div');

  function render(){
    container.innerHTML='';
    if(currentUser){
      const p=document.createElement('p');
      p.innerHTML=`Sesión iniciada como <strong>${esc(currentUser.email||'')}</strong>.`;
      const actions=document.createElement('div');
      actions.className='actions';
      actions.style.flexDirection='column';
      actions.style.alignItems='flex-start';
      const placeholder=document.createElement('button');
      placeholder.type='button';
      placeholder.className='btn ghost';
      placeholder.textContent='Administrar cuenta (próximamente)';
      placeholder.disabled=true;
      placeholder.setAttribute('aria-disabled','true');
      const logout=document.createElement('button');
      logout.type='button';
      logout.className='btn primary';
      logout.textContent='Cerrar sesión';
      logout.addEventListener('click',async ()=>{
        await sb.auth.signOut();
        closeModal();
      });
      actions.append(placeholder,logout);
      container.append(p,actions);
    }else{
      const form=document.createElement('form');
      form.className='account-form';
      const emailField=document.createElement('div');
      emailField.className='field';
      const emailLabel=document.createElement('label');
      emailLabel.setAttribute('for','authEmail');
      emailLabel.textContent='Correo electrónico';
      const emailInput=document.createElement('input');
      emailInput.id='authEmail';
      emailInput.type='email';
      emailInput.placeholder='tucorreo@ejemplo.com';
      emailInput.autocomplete='email';
      emailField.append(emailLabel,emailInput);

      const passField=document.createElement('div');
      passField.className='field';
      const passLabel=document.createElement('label');
      passLabel.setAttribute('for','authPass');
      passLabel.textContent='Contraseña';
      const passWrap=document.createElement('div');
      passWrap.className='pin-wrap';
      const passInput=document.createElement('input');
      passInput.id='authPass';
      passInput.type='password';
      passInput.placeholder='••••••••';
      passInput.autocomplete='current-password';
      const toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='eye';
      toggle.setAttribute('aria-label','Mostrar u ocultar contraseña');
      toggle.textContent='👁';
      toggle.addEventListener('click',()=>{
        const isPass=passInput.type==='password';
        passInput.type=isPass?'text':'password';
        toggle.textContent=isPass?'🙈':'👁';
      });
      passWrap.append(passInput,toggle);
      passField.append(passLabel,passWrap);

      const helper=document.createElement('div');
      helper.className='small';
      helper.textContent='Si es tu primera vez, crearemos tu cuenta automáticamente.';
      const error=document.createElement('div');
      error.className='small';
      error.style.color='var(--danger)';
      const actions=document.createElement('div');
      actions.className='actions';
      actions.style.justifyContent='flex-end';
      const submit=document.createElement('button');
      submit.type='submit';
      submit.className='btn primary';
      submit.textContent='Continuar';
      actions.append(submit);
      const forgot=document.createElement('button');
      forgot.type='button';
      forgot.className='linklike';
      forgot.textContent='¿Olvidaste tu contraseña?';
      const forgotWrap=document.createElement('div');
      forgotWrap.className='small';
      forgotWrap.style.textAlign='left';
      forgotWrap.append(forgot);

      form.append(emailField,passField,actions,helper,error,forgotWrap);

      form.addEventListener('submit',async e=>{
        e.preventDefault();
        error.textContent='';
        const email=(emailInput.value||'').trim();
        const pass=(passInput.value||'').trim();
        if(!email || !pass){
          error.textContent='Completa correo y contraseña.';
          return;
        }
        submit.disabled=true;
        submit.textContent='Procesando…';
        try{
          const r=await autoSignInOrUp(email,pass);
          if(!r.ok){
            error.textContent=r.message||'No se pudo acceder.';
          }else{
            closeModal();
            toast('¡Bienvenido!');
          }
        }catch(err){
          error.textContent=err?.message||'Error inesperado.';
        }finally{
          submit.disabled=false;
          submit.textContent='Continuar';
        }
      });

      forgot.addEventListener('click',async ()=>{
        error.style.color='var(--danger)';
        error.textContent='';
        const email=(emailInput.value||'').trim();
        if(!email){
          error.textContent='Escribe tu correo arriba para enviarte el enlace.';
          return;
        }
        const { error:err } = await sb.auth.resetPasswordForEmail(email,{ redirectTo: location.origin + location.pathname });
        if(err){
          error.textContent=err.message||'No se pudo enviar el correo de recuperación.';
          return;
        }
        error.style.color='var(--success)';
        error.textContent='Te enviamos un correo para restablecer tu contraseña.';
      });

      container.append(form);
      requestAnimationFrame(()=>emailInput.focus());
    }
  }

  render();
  accountModalUpdater=render;

  return {
    title:'Cuenta',
    content:container,
    onOpen(){ const focusable=getFocusable(container); if(focusable.length) focusable[0].focus(); },
    onClose(){ accountModalUpdater=null; }
  };
}

function buildChatModal(){
  const container=document.createElement('div');
  const log=document.createElement('div');
  log.className='chat-log';
  const inputWrap=document.createElement('div');
  inputWrap.className='chat-controls';
  const textarea=document.createElement('textarea');
  textarea.placeholder='Escribe un mensaje…';
  textarea.rows=3;
  const send=document.createElement('button');
  send.type='button';
  send.className='btn primary';
  send.textContent='Enviar';
  inputWrap.append(textarea,send);
  const shareLabel=document.createElement('label');
  shareLabel.className='small';
  shareLabel.style.display='flex';
  shareLabel.style.alignItems='center';
  shareLabel.style.gap='8px';
  const share=document.createElement('input');
  share.type='checkbox';
  share.checked=false;
  shareLabel.append(share,document.createTextNode('Compartir datos sensibles (PIN y notas)'));
  const info=document.createElement('div');
  info.className='small';
  info.textContent='Conexión directa a Gemini desde el navegador (API key expuesta).';

  container.append(log,inputWrap,shareLabel,info);

  chatUIRefs={ log,input:textarea,send,share };
  renderChat();

  send.addEventListener('click',sendChat);
  textarea.addEventListener('keydown',e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }
  });

  return {
    title:'Chat IA',
    content:container,
    onOpen(){ setTimeout(()=>textarea.focus(),50); },
    onClose(){ chatUIRefs=null; }
  };
}

const modalBuilders={
  search:buildSearchModal,
  status:buildStatusModal,
  theme:buildThemeModal,
  account:buildAccountModal,
  chat:buildChatModal
};

overlay?.addEventListener('click',()=>closeModal());
modalCloseButton?.addEventListener('click',()=>closeModal());
modal?.addEventListener('click',e=>{ if(e.target===modal) closeModal(); });

nav?.addEventListener('click',e=>{
  const btn=e.target.closest('.nav-item');
  if(!btn || !nav.contains(btn)) return;
  e.preventDefault();
  closeSidebar();
  openModalFor(btn.dataset.action, btn);
});

function diasRestantes(iso){
  if(!iso) return null; const h=new Date();h.setHours(0,0,0,0);
  const d=new Date(iso); d.setHours(0,0,0,0);
  return Math.round((d-h)/(1000*60*60*24));
}
function estadoDe(vence){
  if(!vence) return ''; const d=diasRestantes(vence);
  if(d<0) return 'vencida'; if(d<=7) return 'pronto'; return 'vigente';
}
function limpiar(){ editId=null; for(const k in f){ if('value' in f[k]) f[k].value=''; } renderServicios(); msg.textContent=''; }

function updateThemeControls(mode){
  if(navThemeLabel){ navThemeLabel.textContent = mode==='light' ? 'Tema claro' : 'Tema oscuro'; }
  if(themeNavButton){
    themeNavButton.setAttribute('aria-label', `Cambiar tema (actual: ${mode==='light'?'claro':'oscuro'})`);
  }
}

function applyTheme(mode,{persist=true}={}){
  const normalized = mode==='light' ? 'light' : 'dark';
  document.body.classList.toggle('theme-light', normalized==='light');
  if(persist){
    try{ localStorage.setItem(THEME_STORAGE_KEY, normalized); }catch(err){ console.warn('No se pudo guardar el tema', err); }
  }
  updateThemeControls(normalized);
  return normalized;
}

const storedTheme = (()=>{ try{ return localStorage.getItem(THEME_STORAGE_KEY); }catch{ return null; } })();
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
const initialTheme = storedTheme==='light' ? 'light' : (storedTheme==='dark' ? 'dark' : (prefersDark ? 'dark' : 'light'));
applyTheme(initialTheme,{persist:false});

/* ====== Semillas / almacenamiento local de servicios (fallback si no hay sesión) ====== */
const defaultServices = ["ChatGPT","Gemini","YouTube","Disney"];
let localServices = JSON.parse(localStorage.getItem('services_local') || 'null');
if (!Array.isArray(localServices) || !localServices.length) {
  localServices = defaultServices.slice();
  localStorage.setItem('services_local', JSON.stringify(localServices));
}
function saveLocalServices() {
  localServices = Array.from(new Set(localServices))
    .filter(Boolean)
    .sort((a,b)=>a.localeCompare(b));
  localStorage.setItem('services_local', JSON.stringify(localServices));
}

const LOCAL_CLIENTS_KEY = 'clients_local_v1';
function loadLocalClients(){
  try {
    const raw = localStorage.getItem(LOCAL_CLIENTS_KEY);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    if (Array.isArray(parsed)) {
      const filtered = parsed
        .filter(x => x && typeof x === 'object')
        .map(x => ({ ...x }));
      filtered.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
      return filtered;
    }
  } catch (err) {
    console.warn('No se pudieron cargar clientes locales', err);
  }
  return [];
}
let localClients = loadLocalClients();
function saveLocalClients(){
  try {
    localClients = (Array.isArray(localClients)? localClients:[])
      .filter(x => x && typeof x === 'object')
      .map(x => ({ ...x }))
      .sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
    localStorage.setItem(LOCAL_CLIENTS_KEY, JSON.stringify(localClients));
  } catch (err) {
    console.warn('No se pudieron guardar clientes locales', err);
  }
}

/* ====== AUTH (Supabase) — modal unificado ====== */
let currentUser = null;

sb.auth.onAuthStateChange((_e, session)=>{
  currentUser = session?.user || null;
  authUpdateUI();
  // Sincroniza local → nube si la nube está vacía
  syncLocalServicesToCloudIfEmpty().finally(()=>{
    renderServicios().then(renderTabla);
  });
});

function authUpdateUI(){
  if(navAccountLabel){
    navAccountLabel.textContent = currentUser ? 'Mi cuenta' : 'Cuenta';
  }
  if(accountNavButton){
    const tooltip=accountNavButton.querySelector('.tooltip');
    if(tooltip){
      tooltip.textContent = currentUser ? `Cuenta (${currentUser.email})` : 'Cuenta invitado';
    }
    accountNavButton.setAttribute('aria-label', currentUser ? `Gestionar cuenta (${currentUser.email})` : 'Gestionar cuenta (invitado)');
  }
  if(typeof accountModalUpdater==='function'){
    accountModalUpdater();
  }
}

authUpdateUI();

  sidebarToggle?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleSidebar(); });
sidebarClose?.addEventListener('click', (e)=>{ e.stopPropagation(); closeSidebar(); });
sidebarBackdrop?.addEventListener('click', ()=> closeSidebar());
document.addEventListener('click', (e)=>{
  if(!sidebar) return;
  if(!sidebar.classList.contains('open')) return;
  if(sidebar.contains(e.target)) return;
  if(e.target===sidebarToggle) return;
  closeSidebar();
});
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){
    closeModal();
    closeSidebar();
  }
  if(e.key==='Tab' && modal?.classList.contains('open')){
    const focusables=getFocusable(modal);
    if(!focusables.length) return;
    const first=focusables[0];
    const last=focusables[focusables.length-1];
    if(e.shiftKey){
      if(document.activeElement===first){
        e.preventDefault();
        last.focus();
      }
    }else{
      if(document.activeElement===last){
        e.preventDefault();
        first.focus();
      }
    }
  }
});

// ----- Lógica unificada: registrar o iniciar sesión -----
async function autoSignInOrUp(email, password) {
  // 1) Intenta iniciar sesión primero
  let { error } = await sb.auth.signInWithPassword({ email, password });
  if (!error) return { ok: true };

  // 2) Si falla, crea la cuenta (sin confirmación por email)
  const { data, error: eUp } = await sb.auth.signUp({ email, password });
  if (eUp) return { ok: false, message: eUp.message };

  // 3) Por si la API no devolviera sesión, intenta loguear de nuevo
  if (!data.session) {
    const { error: eIn2 } = await sb.auth.signInWithPassword({ email, password });
    if (eIn2) return { ok: false, message: eIn2.message };
  }
  return { ok: true };
}

/* ====== DB en la nube (Supabase) ====== */
let cacheClientes = localClients.slice();
let cacheServicios = [];

const db = {
  // CLIENTES
  getAll(){ return currentUser ? cacheClientes.slice() : localClients.slice(); },
  async fetchAll(){
    if(!currentUser){
      localClients = loadLocalClients();
      cacheClientes = localClients.slice();
      return cacheClientes.slice();
    }
    const { data, error } = await sb
      .from('clients').select('*')
      .eq('user_id', currentUser.id)
      .order('nombre', { ascending:true });
    if(error){ console.error(error); cacheClientes=[]; return cacheClientes; }
    cacheClientes = data||[];
    return cacheClientes.slice();
  },

  // *** saveOne robusto: UUID o BIGSERIAL ***
  async saveOne(rec){
    if(!currentUser){
      localClients = loadLocalClients();
      const recId = rec.id ?? crypto.randomUUID();
      const idx = localClients.findIndex(x=>x.id===recId);
      const payload = { ...(idx>=0? localClients[idx]:{}), ...rec, id: recId };
      if(idx>=0) localClients[idx] = payload;
      else localClients.push(payload);
      localClients.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
      saveLocalClients();
      cacheClientes = localClients.slice();
      return payload;
    }

    const rowNoId = {
      user_id: currentUser.id,
      nombre:   rec.nombre,
      email:    rec.email,
      telefono: rec.telefono,
      servicio: rec.servicio,
      inicio:   rec.inicio,
      vence:    rec.vence,
      categoria:rec.categoria,
      notas:    rec.notas,
      pin:      rec.pin,
      ts:       rec.ts
    };

    let data, error;
    const hasId = rec.id!==undefined && rec.id!==null && `${rec.id}`.trim()!=='';

    if (!hasId) {
      ({ data, error } = await sb
        .from('clients')
        .insert(rowNoId)
        .select()
        .single());
    } else {
      ({ data, error } = await sb
        .from('clients')
        .update(rowNoId)
        .eq('id', rec.id)
        .select()
        .single());

      if (error) {
        ({ data, error } = await sb
          .from('clients')
          .upsert({ ...rowNoId, id: rec.id }, { onConflict: 'id' })
          .select()
          .single());
      }
    }

    if (error) throw error;

    const i = cacheClientes.findIndex(x=>x.id===data.id);
    if(i>=0) cacheClientes[i]=data; else cacheClientes.push(data);
    cacheClientes.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
    return data;
  },

  async deleteOne(id){
    if(!currentUser){
      localClients = loadLocalClients().filter(x=>x && x.id!==id);
      saveLocalClients();
      cacheClientes = localClients.slice();
      return;
    }
    const { error } = await sb.from('clients').delete().eq('id', id);
    if(error) throw error;
    cacheClientes = cacheClientes.filter(x=>x.id!==id);
  },
  async saveAll(arr){
    if(!currentUser){
      localClients = arr.map(x=>({ ...x }));
      localClients.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
      saveLocalClients();
      cacheClientes = localClients.slice();
      return;
    }
    const rows = arr.map(x=>({ ...x, user_id: currentUser.id }));
    const { error } = await sb.from('clients').upsert(rows, { onConflict:'id' });
    if(error) throw error;
    cacheClientes = arr.slice();
  },

  // ===== SERVICIOS con fallback local =====
  getServicios(){ return currentUser ? cacheServicios.slice() : localServices.slice(); },

  async fetchServicios(){
    if (!currentUser) {
      return localServices.slice();
    }
    const { data, error } = await sb
      .from('services').select('name')
      .eq('user_id', currentUser.id)
      .order('name');
    if(error){ console.error(error); cacheServicios = []; return []; }
    cacheServicios = (data||[]).map(x=>x.name);
    return cacheServicios.slice();
  },

  async replaceServicios(list){
    if (!currentUser) {
      localServices = list.slice();
      saveLocalServices();
      return;
    }
    const { data: curr } = await sb
      .from('services').select('name')
      .eq('user_id', currentUser.id);
    const has = new Set((curr||[]).map(x=>x.name));
    const want = new Set(list);
    const toDel = [...has].filter(n=>!want.has(n));
    if (toDel.length) {
      await sb.from('services').delete().in('name', toDel).eq('user_id', currentUser.id);
    }
    const toIns = [...want].filter(n=>!has.has(n)).map(n=>({ user_id: currentUser.id, name:n }));
    if (toIns.length) {
      await sb.from('services').insert(toIns);
    }
    cacheServicios = list.slice();
  }
};

/* ===== Sincroniza local → nube si la nube está vacía ===== */
async function syncLocalServicesToCloudIfEmpty(){
  if (!currentUser) return;
  const cloud = await db.fetchServicios();
  if (cloud.length === 0 && localServices.length) {
    await db.replaceServicios(localServices);
    localStorage.removeItem('services_local');
  }
}

/* ====== UI dinámica ====== */
async function renderServicios(sel){
  const list = await db.fetchServicios();
  const final = list.length ? list : defaultServices;
  f.servicio.innerHTML = final.map(s=>`<option value="${s}">${s}</option>`).join('');
  if(sel && final.includes(sel)) f.servicio.value=sel;
  else if(final.length) f.servicio.value=final[0];
  else f.servicio.value='';
}
async function renderTabla(){
  const arr = await db.fetchAll();
  const items=arr.filter(x=>coincide(x,searchTerm)&&pasaEstado(x,estadoFiltro));
  tbody.innerHTML=items.map(x=>{
    const d=diasRestantes(x.vence); const est=estadoDe(x.vence);
    const tag=est==='vigente'?'ok':est==='pronto'?'warn':'bad';
    const estTxt=est?est[0].toUpperCase()+est.slice(1):'-';
    const diasTxt= d==null?'-':(d<0?`Vencido ${Math.abs(d)} d`:`Faltan ${d} d`);
    return `<tr>
      <td>${esc(x.nombre)}</td>
      <td>${esc(x.email||'')}</td>
      <td>${esc(x.servicio||'')}</td>
      <td>${fmt(x.inicio)}</td>
      <td>${fmt(x.vence)}</td>
      <td>${est?`<span class="tag ${tag}">${estTxt}</span>`:'-'}</td>
      <td>${diasTxt}</td>
      <td style="text-align:right">
        <div class="menu-wrap">
          <button class="kebab" data-menu-toggle aria-haspopup="menu" aria-expanded="false"><span class="dots">⋯</span></button>
          <div class="menu" role="menu">
            <button class="menu-item" role="menuitem" data-action="edit" data-id="${x.id}">✎ Editar</button>
            <button class="menu-item" role="menuitem" data-action="label" data-id="${x.id}">🏷 Etiqueta</button>
            <button class="menu-item danger" role="menuitem" data-action="delete" data-id="${x.id}">🗑 Eliminar</button>
          </div>
        </div>
      </td>
    </tr>`;
  }).join('');
}
function coincide(x,term){
  term=(term||'').trim().toLowerCase(); if(!term) return true;
  return [x.nombre,x.email,x.servicio,x.telefono,x.categoria,x.notas]
    .some(v=>(v||'').toLowerCase().includes(term));
}
function pasaEstado(x,f){ if(!f) return true; return estadoDe(x.vence)===f; }

$('#btnLimpiar').onclick=limpiar;

// *** Agregar/editar cliente ***
$('#btnGuardar').onclick = async ()=>{
  const data={
    nombre:f.nombre.value.trim(), email:f.email.value.trim(), telefono:f.telefono.value.trim(),
    servicio:f.servicio.value, inicio:f.inicio.value, vence:f.vence.value,
    categoria:f.categoria.value, notas:f.notas.value.trim(), pin:f.pin.value.trim(), ts:Date.now()
  };
  if(editId!==null && editId!==undefined){
    data.id = editId;
  }
  if(!data.nombre){ toast('Escribe un nombre'); return; }
  const wasGuest = !currentUser;
  try{
    await db.saveOne(data);
    await renderTabla();
    limpiar();
    if(wasGuest && !currentUser){
      toast('Guardado local ✓  Accede para sincronizar');
    }else{
      toast('Guardado ✓');
    }
  }catch(err){
    const msgErr = err?.message || '';
    if(/autentic/i.test(msgErr)){
      toast('Debes iniciar sesión para guardar en la nube.');
    }else{
      toast(msgErr || 'No se pudo guardar.');
    }
  }
};

function editar(id){
  const x=db.getAll().find(c=>c.id===id); if(!x) return; editId=x.id;
  for(const k in f){ if(k in x) f[k].value=x[k]||''; }
  msg.textContent='Editando… guarda para aplicar cambios';
}
async function borrar(id){
  if(!confirm('¿Eliminar este cliente?')) return;
  await db.deleteOne(id);
  await renderTabla();
}

/* Menús (kebab + tema) */
function closeAllMenus(except=null){
  document.querySelectorAll('.menu.open').forEach(menu=>{
    if(except && menu===except) return;
    menu.classList.remove('open');
    menu.previousElementSibling?.setAttribute('aria-expanded','false');
  });
}

document.addEventListener('click',(e)=>{
  const wrap=e.target.closest('.menu-wrap');
  const toggle=e.target.closest('[data-menu-toggle]');
  const item=e.target.closest('.menu-item');

  if(!wrap && !item){
    closeAllMenus();
    return;
  }

  if(toggle){
    const menu=toggle.nextElementSibling;
    if(!menu || !menu.classList.contains('menu')) return;
    const isOpen=menu.classList.contains('open');
    if(isOpen){
      menu.classList.remove('open');
      toggle.setAttribute('aria-expanded','false');
    }else{
      closeAllMenus(menu);
      menu.classList.add('open');
      toggle.setAttribute('aria-expanded','true');
    }
  }

  if(item){
    const id=item.dataset.id;
    if(item.dataset.action==='edit') editar(id);
    else if(item.dataset.action==='label') etiquetar(id);
    else if(item.dataset.action==='delete') borrar(id);
    closeAllMenus();
  }
});

document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape') closeAllMenus();
});

/* ===== Botones + y − de servicios ===== */
$('#btnAgregarServicio').onclick = async ()=>{
  const nombre = (prompt('Nombre del nuevo servicio:') || '').trim();
  if (!nombre) return;

  const actuales = await db.fetchServicios();
  if (!actuales.includes(nombre)) {
    actuales.push(nombre);
    actuales.sort((a,b)=>a.localeCompare(b));
    await db.replaceServicios(actuales);

    if (!currentUser) {
      toast('Servicio agregado (local) ✓  Accede para guardar en la nube');
    } else {
      toast('Servicio agregado ✓');
    }
    await renderServicios(nombre);
  } else {
    await renderServicios(nombre);
    toast('Ese servicio ya existe');
  }
};

$('#btnEliminarServicio').onclick = async ()=>{
  const current = f.servicio.value;
  if (!current) { toast('No hay servicio seleccionado'); return; }

  const actuales = await db.fetchServicios();
  if (!actuales.includes(current)) { toast('Ese servicio no está en la lista'); return; }

  if (!confirm(`¿Eliminar "${current}" de la lista de servicios?\n(No afecta a los clientes ya guardados).`)) return;

  const nueva = actuales.filter(s => s !== current);
  await db.replaceServicios(nueva);

  if (!currentUser) {
    toast('Servicio eliminado (local) ✓  Accede para guardar en la nube');
  } else {
    toast('Servicio eliminado ✓');
  }
  await renderServicios();
};

/* Mostrar/Ocultar PIN (form) */
const btnEye=document.getElementById('togglePin');
if(btnEye){ btnEye.addEventListener('click',()=>{ const isPass=f.pin.type==='password'; f.pin.type=isPass?'text':'password'; btnEye.textContent=isPass?'🙈':'👁'; }); }

/* ===== Chat (Gemini) ===== */
const GEMINI_API_KEY = 'AIzaSyC9hpKbGmUx3_YcgVGI3AEOdKvWRSoU81k';
const GEMINI_MODEL  = 'gemini-1.5-flash';
let chatHistory = JSON.parse(localStorage.getItem('chat_v1')||'[]');

function renderChat(){
  if(!chatUIRefs?.log) return;
  chatUIRefs.log.innerHTML = chatHistory
    .map(m=>`<div class="chat-msg ${m.role}"><div class="bubble">${esc(m.text)}</div></div>`)
    .join('');
  chatUIRefs.log.scrollTop = chatUIRefs.log.scrollHeight;
}
renderChat();

function normalize(s){return (s||'').toString().normalize('NFD').replace(/[̀-ͯ]/g,'').toLowerCase();}
function clientToSafe(rec, includeSecrets){
  const d = (function(iso){ if(!iso) return null; const h=new Date();h.setHours(0,0,0,0); const dd=new Date(iso); dd.setHours(0,0,0,0); return Math.round((dd-h)/(1000*60*60*24)); })(rec.vence);
  const est = rec.vence? (d<0?'vencida':(d<=7?'pronto':'vigente')) : '';
  const out = {
    id: rec.id,
    nombre: rec.nombre||'',
    email: rec.email||'',
    telefono: rec.telefono||'',
    servicio: rec.servicio||'',
    inicio: rec.inicio||'',
    vence: rec.vence||'',
    categoria: rec.categoria||'',
    estado: est,
    dias: d
  };
  if(includeSecrets){ if(rec.pin) out.pin = rec.pin; if(rec.notas) out.notas = rec.notas; }
  return out;
}
function buildPrompt(userMsg){
  const includeSecrets = !!(chatUIRefs?.share?.checked);
  const textNorm = normalize(userMsg);
  const clientes = db.getAll();
  const enriched = clientes.map(r=>clientToSafe(r, includeSecrets));
  const matches = enriched.filter(r=>{
    const n=normalize(r.nombre), e=normalize(r.email), s=normalize(r.servicio);
    return (n && textNorm.includes(n)) || (e && textNorm.includes(e)) || (s && textNorm.includes(s));
  });
  const context = (matches.length? matches.slice(0,10) : enriched.slice(0,50));
  const guidance = [
    'Eres un asistente que habla español y ayuda a gestionar clientes.',
    'Usa SOLO los datos proporcionados. Si algo no está en DATOS, di: "no está en mis registros".',
    'Si el usuario pide PIN y no existe el campo "pin" en los DATOS, responde brevemente que por seguridad no lo compartes a menos que el usuario habilite Compartir datos sensibles.',
    'Formatea las respuestas de ficha con etiquetas: Nombre, Email, Teléfono, Servicio, Inicio, Vence, Estado, Días, Categoría, Notas.'
  ];
  const prompt = [
    ...guidance,
    'DATOS(JSON):',
    JSON.stringify(context),
    `PREGUNTA: ${userMsg}`
  ].join('\n');
  return prompt;
}

async function requestGemini(prompt){
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
  const payload = { contents: [{ role:'user', parts:[{ text: prompt }]}] };
  const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const json = await res.json();
  return json?.candidates?.[0]?.content?.parts?.[0]?.text || '(sin respuesta)';
}

async function sendChat(){
  const input=chatUIRefs?.input;
  const sendBtn=chatUIRefs?.send;
  if(!input) return;
  const text=(input.value||'').trim();
  if(!text) return;
  chatHistory.push({ role:'user', text });
  renderChat();
  input.value='';
  if(sendBtn){ sendBtn.disabled=true; sendBtn.textContent='Enviando…'; }
  try{
    const reply = await requestGemini(buildPrompt(text));
    chatHistory.push({ role:'ai', text: reply });
    tryApplyToolFrom(reply, text);
  }catch(err){
    chatHistory.push({ role:'ai', text: `[Error al llamar a Gemini: ${err.message}]` });
  }
  localStorage.setItem('chat_v1', JSON.stringify(chatHistory));
  renderChat();
  if(sendBtn){ sendBtn.disabled=false; sendBtn.textContent='Enviar'; }
}

/* ==== Herramientas locales para aplicar cambios desde el chat ==== */
function parseDateToISO(s){
  if(!s) return s; s=String(s).trim();
  if(s.indexOf('-')>0) return s;
  if(s.indexOf('/')>0){ const parts=s.split('/'); if(parts.length===3){ const d=parts[0].padStart(2,'0'); const m=parts[1].padStart(2,'0'); const y=parts[2]; return `${y}-${m}-${d}`; } }
  return s;
}
function extractJson(text){
  const i = text.indexOf('```json'); if(i>=0){ const j = text.indexOf('```', i+7); if(j>i){ return text.slice(i+7, j).trim(); } }
  const a = text.indexOf('{'); const b = text.lastIndexOf('}');
  if(a>=0 && b>a) return text.slice(a,b+1);
  return null;
}
function tryApplyToolFrom(modelText, userText){
  const raw = extractJson(modelText); if(!raw) return false;
  let cmd; try{ cmd = JSON.parse(raw); }catch{ return false; }
  if(!cmd || cmd.action !== 'update_client' || !cmd.set) return false;
  return applyUpdateCommand(cmd);
}
function findClientByMatch(match){
  const arr = db.getAll(); const t = m=>normalize(m||'');
  let filtered = arr.filter(c=>{
    const okNombre = match?.nombre? t(c.nombre).includes(t(match.nombre)) : true;
    const okEmail  = match?.email?  t(c.email) === t(match.email) || t(c.email).includes(t(match.email)) : true;
    const okServ   = match?.servicio? t(c.servicio).includes(t(match.servicio)) : true;
    return okNombre && okEmail && okServ;
  });
  return filtered;
}
async function applyUpdateCommand(cmd){
  const matches = findClientByMatch(cmd.match||{});
  if(matches.length !== 1){
    const msg = matches.length===0? 'No encontré un cliente con esos datos. Especifica nombre o email.' : `Hay ${matches.length} clientes que coinciden. Especifica email para continuar.`;
    chatHistory.push({role:'ai', text: msg});
    renderChat();
    return false;
  }
  const client = matches[0];
  const allowed = {nombre:1,email:1,telefono:1,servicio:1,inicio:1,vence:1,categoria:1,notas:1,pin:1};
  const set = Object.assign({}, cmd.set);
  if(set.inicio) set.inicio = parseDateToISO(set.inicio);
  if(set.vence)  set.vence  = parseDateToISO(set.vence);

  const arr = db.getAll();
  const idx = arr.findIndex(x=>x.id===client.id);
  if(idx<0){ chatHistory.push({role:'ai', text:'Error interno: no se pudo ubicar el registro.'}); renderChat(); return false; }
  const before = Object.assign({}, arr[idx]);
  Object.keys(set).forEach(k=>{ if(allowed[k]) arr[idx][k] = set[k]; });

  await db.saveAll(arr);
  await renderTabla();

  const changed = Object.keys(set).map(k=>`${k}: "${before[k]||''}" → "${arr[idx][k]}"`).join('\n');
  chatHistory.push({role:'ai', text:`Actualizado ✓\nCliente: ${arr[idx].nombre}\nCambios:\n${changed}`});
  renderChat();
  return true;
}

function formatDM(iso){ if(!iso) return ''; var d=new Date(iso+'T00:00:00'); return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0'); }
function buildEtiqueta(c){
  var svc=(c.servicio||'').toString().toUpperCase();
  var fv=formatDM(c.vence)||'--/--';
  var correo=c.email||'';
  var perfil=c.nombre||'';
  var pin=c.pin||'';
  var t='*'+svc+'* ✨ 📧✨ *FV: '+fv+'*\n';
  t+='*Correo:* '+correo+'\n';
  t+='*Contraseña:* '+'\n';
  t+='__________________'+'\n';
  t+='Perfíl:  '+perfil+'\n';
  t+='PIN:  '+pin+'\n';
  t+='__________________'+'\n';
  t+='💻📲'+'\n';
  t+='    🌟 Gracias por tu compra';
  return t;
}
async function copyToClipboard(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(e){ try{ var ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return true; }catch(_){ return false; } }
}
function etiquetar(id){
  var c=db.getAll().find(function(x){return x.id===id}); if(!c){ toast('Cliente no encontrado'); return; }
  var etiqueta = buildEtiqueta(c);
  copyToClipboard(etiqueta).then(function(ok){ toast(ok?'Etiqueta copiada ✓':'No se pudo copiar'); });
}

/* ===== DEV TESTS (ligeros) ===== */
(function(){
  function runTests(){
    const backupGet = db.getAll, backupSaveAll = db.saveAll;
    let mem = [{id:'1',nombre:'Ana',servicio:'ChatGPT',vence:'2025-10-01',pin:'1234',notas:'vip'}];
    db.getAll = () => JSON.parse(JSON.stringify(mem));
    db.saveAll = (x) => { mem = JSON.parse(JSON.stringify(x)); };

    console.assert(parseDateToISO('20/10/2025') === '2025-10-20','parseDateToISO convierte dd/mm/aaaa');
    applyUpdateCommand({action:'update_client', match:{nombre:'Ana'}, set:{vence:'2025-11-01'}});
    console.assert(mem[0].vence==='2025-11-01','applyUpdateCommand actualiza vence');

    db.getAll = backupGet; db.saveAll = backupSaveAll;
    console.log('[tests] OK');
  }
  try{ runTests(); }catch(e){ console.warn('[tests] fallo:', e); }
})();

/* inicio */
renderServicios().then(()=>renderTabla());
</script>
</body>
</html>
