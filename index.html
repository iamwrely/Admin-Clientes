<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>A√±adir Cliente</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0f241a; --ink-soft:#334155; --muted:#64748b; --bg:#ffffff;
      --field:#f5f6f8; --field-focus:#ffffff; --border:#e6e7eb;
      --pill-bg:#edf7f1; --pill-ink:#19603a; --btn:#222426; --btn-ink:#ffffff;
      --ghost:#ffffff; --ghost-border:#dfe3e8; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --link:#2563eb; --success:#166534; --danger:#b91c1c;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    html,body{margin:0;background:var(--bg);color:var(--ink)}
    a{color:inherit}

    /* ===== Toolbar superior ===== */
    .toolbar{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.92);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border)}
    .toolbar-inner{max-width:980px;margin:0 auto;padding:10px 12px;display:flex;gap:8px;align-items:center}
    .toolbar input,.toolbar select{padding:10px 12px;border-radius:10px;border:1px solid var(--ghost-border);background:#fff;min-width:200px}
    .spacer{flex:1}
    .btn{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn.ghost{background:var(--ghost);border:1px solid var(--ghost-border);}
    .btn.primary{background:var(--btn);color:var(--btn-ink)}
    .linklike{background:none;border:0;color:var(--link);cursor:pointer;padding:0;font-weight:600}

    /* ===== Layout ===== */
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 60px}
    .pill{display:block;width:max-content;margin:0 auto 10px;padding:6px 12px;border-radius:999px;background:var(--pill-bg);color:var(--pill-ink);border:1px solid #cfe7d8;font-size:12px}
    h1{margin:6px 0 16px;text-align:center;font-weight:800;letter-spacing:-0.02em;color:var(--ink);font-size:clamp(36px,8vw,72px);line-height:1.02}

    /* ===== Servicio centrado ===== */
    .center{display:flex;justify-content:center;align-items:center;gap:10px;margin:8px 0 20px}
    .center .label{color:var(--ink-soft)}
    .addserv{border:1px dashed var(--border);background:#fff;padding:8px 10px;border-radius:10px;font-size:14px;min-width:40px;text-align:center}
    .addserv.remove{border-color:#fecaca;color:#7f1d1d}

    /* ===== Form (labels arriba) ===== */
    .form{max-width:560px;margin:0 auto}
    .row{display:flex;flex-direction:column;gap:6px;margin-bottom:14px}
    .row label{color:var(--ink-soft);font-size:14px;font-weight:600}
    input,select,textarea{width:100%;padding:14px;border:1px solid var(--border);border-radius:14px;background:var(--field);outline:none;transition:.15s}
    input:focus,select:focus,textarea:focus{border-color:#cbd5e1;background:var(--field-focus);box-shadow:0 0 0 3px rgba(15, 23, 42, .05)}
    textarea{min-height:88px;resize:vertical}
    .actions{display:flex;justify-content:center;gap:10px;margin-top:18px}
    .small{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
    .pin-wrap{position:relative}
    .pin-wrap .eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:1px solid var(--ghost-border);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer}

    /* ===== Tabla ===== */
    table{width:100%;border-collapse:collapse;margin-top:26px}
    th,td{padding:12px;border-bottom:1px solid var(--border);font-size:14px}
    th{text-align:left;color:#334155}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;display:inline-block;border:1px solid}
    .tag.ok{color:#166534;background:#ecfdf5;border-color:#86efac}
    .tag.warn{color:#92400e;background:#fffbeb;border-color:#fde68a}
    .tag.bad{color:#7f1d1d;background:#fef2f2;border-color:#fecaca}

    /* ===== Kebab ‚ãØ men√∫ ===== */
    .menu-wrap{position:relative;display:inline-block}
    .kebab{border:1px solid var(--border);background:#fff;border-radius:12px;padding:6px 10px;cursor:pointer;line-height:1}
    .kebab .dots{letter-spacing:2px;font-size:18px;color:#64748b}
    .kebab:focus{outline:2px solid #cbd5e1}
    .menu{position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 28px rgba(2,6,23,.08);min-width:160px;padding:6px;display:none;z-index:50}
    .menu.open{display:block}
    .menu-item{display:block;width:100%;text-align:left;background:#fff;border:0;border-radius:8px;padding:9px 10px;cursor:pointer;font-size:14px}
    .menu-item:hover{background:#f3f4f6}
    .menu-item.danger{color:#7f1d1d;border:1px solid #fecaca}

    /* ===== Modales ===== */
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;background:rgba(2,6,23,.45);z-index:100}
    .modal-backdrop.open{display:flex}
    .modal{background:#fff;border:1px solid var(--border);border-radius:16px;width:min(760px,96vw);max-height:90vh;display:flex;flex-direction:column}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .modal .body{padding:12px}

    /* ===== Chat (Gemini) ===== */
    .section-head{font-weight:700;margin-bottom:8px;color:var(--ink)}
    .chat-log{height:260px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:10px;background:#f9fafb}
    .chat-msg{margin:8px 0;display:flex}
    .chat-msg.user{justify-content:flex-end}
    .chat-msg .bubble{max-width:85%;padding:10px 12px;border-radius:12px;white-space:pre-wrap}
    .chat-msg.user .bubble{background:#111827;color:#fff;border:1px solid #0b1220}
    .chat-msg.ai .bubble{background:#fff;border:1px solid var(--border);color:#0b1f16}

    @media (max-width:680px){ .toolbar-inner{flex-wrap:wrap} }
  </style>
</head>
<body>
  <!-- toolbar -->
  <div class="toolbar">
    <div class="toolbar-inner">
      <input id="q" placeholder="Buscar por nombre, email o servicio‚Ä¶"/>
      <select id="filterEstado">
        <option value="">Todos</option>
        <option value="vigente">Vigentes</option>
        <option value="pronto">Por vencer (‚â§7 d√≠as)</option>
        <option value="vencida">Vencidas</option>
      </select>
      <div class="spacer"></div>

      <!-- Acceso unificado (modal) + cerrar sesi√≥n -->
      <button class="btn ghost" id="btnAuthOpen">Acceder</button>
      <button class="btn ghost" id="btnLogout" style="display:none">Cerrar sesi√≥n</button>
      <span id="userInfo" class="pill" style="display:none"></span>

      <button class="btn ghost" id="btnChatOpen" title="Abrir chat con Gemini">Chat Gemini</button>
    </div>
  </div>

  <div class="wrap">
    <span class="pill">importante</span>
    <h1>A√±adir Cliente</h1>

    <div class="center">
      <div class="label">Servicio</div>
      <select id="servicio" style="max-width:260px"></select>
      <button id="btnAgregarServicio" class="addserv" aria-label="Agregar servicio" title="Agregar servicio">+</button>
      <button id="btnEliminarServicio" class="addserv remove" aria-label="Eliminar servicio" title="Eliminar servicio">‚àí</button>
    </div>

    <div class="form">
      <div class="row">
        <label for="nombre">Nombre</label>
        <input id="nombre" placeholder="Escribe"/>
      </div>
      <div class="row">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="ej: cliente@mail.com"/>
      </div>
      <div class="row">
        <label for="telefono">Tel√©fono</label>
        <input id="telefono" placeholder="+51 ‚Ä¶"/>
      </div>
      <div class="row">
        <label for="inicio">Fecha</label>
        <input id="inicio" type="date" />
      </div>
      <div class="row">
        <label for="vence">Vence</label>
        <input id="vence" type="date" />
      </div>
      <div class="row">
        <label for="pin">PIN</label>
        <div class="pin-wrap">
          <input id="pin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          <button type="button" class="eye" id="togglePin" aria-label="Mostrar/ocultar PIN">üëÅ</button>
        </div>
      </div>
      <div class="row">
        <label for="categoria">Categor√≠a</label>
        <select id="categoria">
          <option value="">Selecciona una opci√≥n</option>
          <option>Premium</option>
          <option>Est√°ndar</option>
          <option>B√°sico</option>
        </select>
      </div>
      <div class="row">
        <label for="notas">Notas</label>
        <textarea id="notas" placeholder="Plan, precio, usuario, etc."></textarea>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnGuardar">Agregar</button>
        <button class="btn ghost" id="btnLimpiar">Limpiar</button>
      </div>
      <div class="small" id="msg"></div>
    </div>

    <!-- tabla -->
    <table id="tabla">
      <thead>
        <tr>
          <th>Nombre</th><th>Email</th><th>Servicio</th>
          <th>Inicio</th><th>Vence</th><th>Estado</th><th>D√≠as</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ===== Modal Chat Gemini ===== -->
  <div id="chatModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Chat Gemini">
      <header>
        <strong>Chat Gemini</strong>
        <button class="btn ghost" id="btnChatClose">Cerrar</button>
      </header>
      <div class="body">
        <div id="chatLog" class="chat-log"></div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:10px">
          <input id="chatInput" placeholder="Escribe un mensaje‚Ä¶"/>
          <button class="btn primary" id="btnSend">Enviar</button>
        </div>
        <div class="small" style="text-align:left;margin-top:6px">
          <label><input type="checkbox" id="shareSecrets"> Compartir datos sensibles (PIN y notas)</label>
        </div>
        <div class="small">Conexi√≥n directa a Gemini desde el navegador (API key expuesta).</div>
      </div>
    </div>
  </div>

  <!-- ===== Modal Acceso (login/registro en 1) ===== -->
  <div id="authModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Acceder">
      <header>
        <strong>Acceder</strong>
        <button class="btn ghost" id="btnAuthClose">Cancelar</button>
      </header>
      <div class="body">
        <div class="row">
          <label for="authEmail">Correo</label>
          <input id="authEmail" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email">
        </div>
        <div class="row">
          <label for="authPass">Contrase√±a</label>
          <div class="pin-wrap">
            <input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            <button type="button" class="eye" id="toggleAuthPass" aria-label="Mostrar/ocultar contrase√±a">üëÅ</button>
          </div>
        </div>

        <div class="small" style="text-align:left;margin-top:0">
          <button id="btnForgot" class="linklike" type="button">¬øOlvidaste tu contrase√±a?</button>
        </div>

        <div class="actions" style="justify-content:flex-end">
          <button class="btn primary" id="btnAuthSubmit">Continuar</button>
        </div>
        <div class="small" id="authHelp">Si es tu primera vez, crearemos tu cuenta autom√°ticamente. Puede que debas confirmar el correo.</div>
        <div class="small" id="authError" style="color:var(--danger)"></div>
      </div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* ====== CONFIG Supabase ====== */
const SUPABASE_URL = 'https://sevhzvoibsuqcjroefgb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNldmh6dm9pYnN1cWNqcm9lZmdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MzUxMzQsImV4cCI6MjA3NDAxMTEzNH0.whFwTL-5UuwwpsZBzs7auzMm8t2mvZ1ldndPkstDDDE';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== helpers y refs ===== */
const $=s=>document.querySelector(s);
const tbody=$('#tabla tbody');
const f={nombre:$('#nombre'),email:$('#email'),telefono:$('#telefono'),
servicio:$('#servicio'),inicio:$('#inicio'),vence:$('#vence'),notas:$('#notas'),
categoria:$('#categoria'), pin:$('#pin')};
const q=$('#q'), filterEstado=$('#filterEstado'), msg=$('#msg');
let editId=null;

function toast(t){ msg.textContent=t; setTimeout(()=>msg.textContent='',2200); }
function esc(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;' }[m]))}
function fmt(iso){return iso? new Date(iso+'T00:00:00').toLocaleDateString(): '-'}

function diasRestantes(iso){
  if(!iso) return null; const h=new Date();h.setHours(0,0,0,0);
  const d=new Date(iso); d.setHours(0,0,0,0);
  return Math.round((d-h)/(1000*60*60*24));
}
function estadoDe(vence){
  if(!vence) return ''; const d=diasRestantes(vence);
  if(d<0) return 'vencida'; if(d<=7) return 'pronto'; return 'vigente';
}
function limpiar(){ editId=null; for(const k in f){ if('value' in f[k]) f[k].value=''; } renderServicios(); msg.textContent=''; }

/* ====== Semillas / almacenamiento local de servicios (fallback si no hay sesi√≥n) ====== */
const defaultServices = ["ChatGPT","Gemini","YouTube","Disney"];
let localServices = JSON.parse(localStorage.getItem('services_local') || 'null');
if (!Array.isArray(localServices) || !localServices.length) {
  localServices = defaultServices.slice();
  localStorage.setItem('services_local', JSON.stringify(localServices));
}
function saveLocalServices() {
  localServices = Array.from(new Set(localServices))
    .filter(Boolean)
    .sort((a,b)=>a.localeCompare(b));
  localStorage.setItem('services_local', JSON.stringify(localServices));
}

/* ====== AUTH (Supabase) ‚Äî modal unificado ====== */
let currentUser = null;

sb.auth.onAuthStateChange((_e, session)=>{
  currentUser = session?.user || null;
  authUpdateUI();
  // Sincroniza local ‚Üí nube si la nube est√° vac√≠a
  syncLocalServicesToCloudIfEmpty().finally(()=>{
    renderServicios().then(renderTabla);
  });
});

function authUpdateUI(){
  const badge = document.getElementById('userInfo');
  const btnAuthOpen = document.getElementById('btnAuthOpen');
  const btnLogout = document.getElementById('btnLogout');
  if(currentUser){
    badge.style.display='inline-block';
    badge.textContent = currentUser.email;
    btnAuthOpen.style.display='none';
    btnLogout.style.display='inline-block';
  }else{
    badge.style.display='none';
    btnAuthOpen.style.display='inline-block';
    btnLogout.style.display='none';
  }
}

// ----- Modal helpers -----
const authModal    = document.getElementById('authModal');
const btnAuthOpen  = document.getElementById('btnAuthOpen');
const btnAuthClose = document.getElementById('btnAuthClose');
const btnAuthSubmit= document.getElementById('btnAuthSubmit');
const authEmailEl  = document.getElementById('authEmail');
const authPassEl   = document.getElementById('authPass');
const authErrorEl  = document.getElementById('authError');
const toggleAuthPass = document.getElementById('toggleAuthPass');
const btnForgot    = document.getElementById('btnForgot');

function openAuth(){ authErrorEl.textContent=''; authErrorEl.style.color='var(--danger)'; authModal.classList.add('open'); authModal.setAttribute('aria-hidden','false'); setTimeout(()=>authEmailEl?.focus(), 0); }
function closeAuth(){ authModal.classList.remove('open'); authModal.setAttribute('aria-hidden','true'); }

btnAuthOpen?.addEventListener('click', openAuth);
btnAuthClose?.addEventListener('click', closeAuth);
authModal?.addEventListener('click', (e)=>{ if(e.target===authModal) closeAuth(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeAuth(); });

toggleAuthPass?.addEventListener('click', ()=>{
  const isPass = authPassEl.type==='password';
  authPassEl.type = isPass? 'text':'password';
  toggleAuthPass.textContent = isPass? 'üôà':'üëÅ';
});

// ----- L√≥gica unificada: registrar o iniciar sesi√≥n -----
async function autoSignInOrUp(email, password){
  const { data: up, error: eUp } = await sb.auth.signUp({
    email, password,
    options: { emailRedirectTo: location.origin + location.pathname }
  });
  if(!eUp){
    if(!up.session){
      return { ok:true, needConfirm:true, message:'Te enviamos un enlace de confirmaci√≥n a tu correo.' };
    }
    return { ok:true };
  }
  if(/registered|exists/i.test(eUp.message||'')){
    const { error: eIn } = await sb.auth.signInWithPassword({ email, password });
    if(eIn) return { ok:false, message: eIn.message||'No se pudo iniciar sesi√≥n' };
    return { ok:true };
  }
  const { error: eIn2 } = await sb.auth.signInWithPassword({ email, password });
  if(eIn2) return { ok:false, message: eUp.message||eIn2.message||'Error de acceso' };
  return { ok:true };
}

btnAuthSubmit?.addEventListener('click', async ()=>{
  const email = (authEmailEl.value||'').trim();
  const pass  = (authPassEl.value||'').trim();
  authErrorEl.textContent = '';
  authErrorEl.style.color = 'var(--danger)';
  if(!email || !pass){
    authErrorEl.textContent = 'Completa correo y contrase√±a.';
    return;
  }
  btnAuthSubmit.disabled = true; btnAuthSubmit.textContent = 'Procesando‚Ä¶';
  try{
    const r = await autoSignInOrUp(email, pass);
    if(!r.ok){
      authErrorEl.textContent = r.message || 'No se pudo acceder.';
    }else{
      if(r.needConfirm){
        authErrorEl.style.color = 'var(--success)';
        authErrorEl.textContent = r.message;
      }else{
        closeAuth(); toast('¬°Bienvenido!');
      }
    }
  }catch(err){
    authErrorEl.textContent = err.message || 'Error inesperado.';
  }finally{
    btnAuthSubmit.disabled = false; btnAuthSubmit.textContent = 'Continuar';
  }
});

document.getElementById('btnLogout')?.addEventListener('click', async ()=>{ await sb.auth.signOut(); });

// ----- ¬øOlvidaste tu contrase√±a? -----
btnForgot?.addEventListener('click', async ()=>{
  const email = (authEmailEl.value||'').trim();
  authErrorEl.style.color = 'var(--danger)';
  authErrorEl.textContent = '';
  if(!email){ authErrorEl.textContent = 'Escribe tu correo arriba para enviarte el enlace.'; return; }
  const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo: location.origin + location.pathname });
  if(error){ authErrorEl.textContent = error.message || 'No se pudo enviar el correo de recuperaci√≥n.'; return; }
  authErrorEl.style.color = 'var(--success)';
  authErrorEl.textContent = 'Te enviamos un correo para restablecer tu contrase√±a.';
});

/* ====== DB en la nube (Supabase) ====== */
let cacheClientes = [];
let cacheServicios = [];

const db = {
  // CLIENTES
  getAll(){ return cacheClientes.slice(); },
  async fetchAll(){
    if(!currentUser){ cacheClientes=[]; return cacheClientes; }
    const { data, error } = await sb
      .from('clients').select('*')
      .eq('user_id', currentUser.id)
      .order('nombre', { ascending:true });
    if(error){ console.error(error); cacheClientes=[]; return cacheClientes; }
    cacheClientes = data||[];
    return cacheClientes.slice();
  },
  async saveOne(rec){
    if(!currentUser) throw new Error('No autenticado');
    const row = { ...rec, user_id: currentUser.id };
    const { data, error } = await sb
      .from('clients').upsert(row, { onConflict:'id' })
      .select().limit(1).single();
    if(error) throw error;
    const i = cacheClientes.findIndex(x=>x.id===data.id);
    if(i>=0) cacheClientes[i]=data; else cacheClientes.push(data);
    cacheClientes.sort((a,b)=>a.nombre.localeCompare(b.nombre));
    return data;
  },
  async deleteOne(id){
    if(!currentUser) throw new Error('No autenticado');
    const { error } = await sb.from('clients').delete().eq('id', id);
    if(error) throw error;
    cacheClientes = cacheClientes.filter(x=>x.id!==id);
  },
  async saveAll(arr){
    if(!currentUser) throw new Error('No autenticado');
    const rows = arr.map(x=>({ ...x, user_id: currentUser.id }));
    const { error } = await sb.from('clients').upsert(rows, { onConflict:'id' });
    if(error) throw error;
    cacheClientes = arr.slice();
  },

  // ===== SERVICIOS con fallback local =====
  getServicios(){ return currentUser ? cacheServicios.slice() : localServices.slice(); },

  async fetchServicios(){
    if (!currentUser) {
      return localServices.slice();
    }
    const { data, error } = await sb
      .from('services').select('name')
      .eq('user_id', currentUser.id)
      .order('name');
    if(error){ console.error(error); cacheServicios = []; return []; }
    cacheServicios = (data||[]).map(x=>x.name);
    return cacheServicios.slice();
  },

  async replaceServicios(list){
    if (!currentUser) {
      localServices = list.slice();
      saveLocalServices();
      return;
    }
    const { data: curr } = await sb
      .from('services').select('name')
      .eq('user_id', currentUser.id);
    const has = new Set((curr||[]).map(x=>x.name));
    const want = new Set(list);
    const toDel = [...has].filter(n=>!want.has(n));
    if (toDel.length) {
      await sb.from('services').delete().in('name', toDel).eq('user_id', currentUser.id);
    }
    const toIns = [...want].filter(n=>!has.has(n)).map(n=>({ user_id: currentUser.id, name:n }));
    if (toIns.length) {
      await sb.from('services').insert(toIns);
    }
    cacheServicios = list.slice();
  }
};

/* ===== Sincroniza local ‚Üí nube si la nube est√° vac√≠a ===== */
async function syncLocalServicesToCloudIfEmpty(){
  if (!currentUser) return;
  const cloud = await db.fetchServicios();
  if (cloud.length === 0 && localServices.length) {
    await db.replaceServicios(localServices);
    localStorage.removeItem('services_local');
  }
}

/* ====== UI din√°mica ====== */
async function renderServicios(sel){
  const list = await db.fetchServicios();
  const final = list.length ? list : defaultServices;
  f.servicio.innerHTML = final.map(s=>`<option value="${s}">${s}</option>`).join('');
  if(sel && final.includes(sel)) f.servicio.value=sel;
  else if(final.length) f.servicio.value=final[0];
  else f.servicio.value='';
}
async function renderTabla(){
  const arr = await db.fetchAll();
  const items=arr.filter(x=>coincide(x,q?.value)&&pasaEstado(x,filterEstado?.value));
  tbody.innerHTML=items.map(x=>{
    const d=diasRestantes(x.vence); const est=estadoDe(x.vence);
    const tag=est==='vigente'?'ok':est==='pronto'?'warn':'bad';
    const estTxt=est?est[0].toUpperCase()+est.slice(1):'-';
    const diasTxt= d==null?'-':(d<0?`Vencido ${Math.abs(d)} d`:`Faltan ${d} d`);
    return `<tr>
      <td>${esc(x.nombre)}</td>
      <td>${esc(x.email||'')}</td>
      <td>${esc(x.servicio||'')}</td>
      <td>${fmt(x.inicio)}</td>
      <td>${fmt(x.vence)}</td>
      <td>${est?`<span class="tag ${tag}">${estTxt}</span>`:'-'}</td>
      <td>${diasTxt}</td>
      <td style="text-align:right">
        <div class="menu-wrap">
          <button class="kebab" aria-haspopup="menu" aria-expanded="false"><span class="dots">‚ãØ</span></button>
          <div class="menu" role="menu">
            <button class="menu-item" role="menuitem" data-action="edit" data-id="${x.id}">‚úé Editar</button>
            <button class="menu-item" role="menuitem" data-action="label" data-id="${x.id}">üè∑ Etiqueta</button>
            <button class="menu-item danger" role="menuitem" data-action="delete" data-id="${x.id}">üóë Eliminar</button>
          </div>
        </div>
      </td>
    </tr>`;
  }).join('');
}
function coincide(x,qq){
  qq=(qq||'').trim().toLowerCase(); if(!qq) return true;
  return [x.nombre,x.email,x.servicio,x.telefono,x.categoria,x.notas]
    .some(v=>(v||'').toLowerCase().includes(qq));
}
function pasaEstado(x,f){ if(!f) return true; return estadoDe(x.vence)===f; }

$('#btnLimpiar').onclick=limpiar;

$('#btnGuardar').onclick = async ()=>{
  const data={ id:editId ?? crypto.randomUUID(),
    nombre:f.nombre.value.trim(), email:f.email.value.trim(), telefono:f.telefono.value.trim(),
    servicio:f.servicio.value, inicio:f.inicio.value, vence:f.vence.value,
    categoria:f.categoria.value, notas:f.notas.value.trim(), pin:f.pin.value.trim(), ts:Date.now()
  };
  if(!data.nombre){ toast('Escribe un nombre'); return; }
  await db.saveOne(data);
  await renderTabla(); limpiar(); toast('Guardado ‚úì');
};

function editar(id){
  const x=db.getAll().find(c=>c.id===id); if(!x) return; editId=x.id;
  for(const k in f){ if(k in x) f[k].value=x[k]||''; }
  msg.textContent='Editando‚Ä¶ guarda para aplicar cambios';
}
async function borrar(id){
  if(!confirm('¬øEliminar este cliente?')) return;
  await db.deleteOne(id);
  await renderTabla();
}

/* kebab: abrir/cerrar y acciones */
document.addEventListener('click', (e)=>{
  const wrap=e.target.closest('.menu-wrap');
  const isKebab=e.target.closest('.kebab');
  const item=e.target.closest('.menu-item');

  if(!wrap && !item){
    document.querySelectorAll('.menu.open').forEach(m=>{ m.classList.remove('open'); m.previousElementSibling?.setAttribute('aria-expanded','false');});
  }
  if(isKebab){
    const menu=isKebab.nextElementSibling;
    document.querySelectorAll('.menu.open').forEach(m=>{ if(m!==menu){ m.classList.remove('open'); m.previousElementSibling?.setAttribute('aria-expanded','false');}});
    const isOpen=menu.classList.toggle('open');
    isKebab.setAttribute('aria-expanded', isOpen?'true':'false');
  }
  if(item){
    const id=item.dataset.id;
    if(item.dataset.action==='edit') editar(id);
    else if(item.dataset.action==='label') etiquetar(id);
    else if(item.dataset.action==='delete') borrar(id);
    document.querySelectorAll('.menu.open').forEach(m=>{ m.classList.remove('open'); m.previousElementSibling?.setAttribute('aria-expanded','false');});
  }
});
document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){
    document.querySelectorAll('.menu.open').forEach(m=>{ m.classList.remove('open'); m.previousElementSibling?.setAttribute('aria-expanded','false');});
  }
});

/* ===== Botones + y ‚àí de servicios ===== */
$('#btnAgregarServicio').onclick = async ()=>{
  const nombre = (prompt('Nombre del nuevo servicio:') || '').trim();
  if (!nombre) return;

  const actuales = await db.fetchServicios();
  if (!actuales.includes(nombre)) {
    actuales.push(nombre);
    actuales.sort((a,b)=>a.localeCompare(b));
    await db.replaceServicios(actuales);

    if (!currentUser) {
      toast('Servicio agregado (local) ‚úì  Accede para guardar en la nube');
    } else {
      toast('Servicio agregado ‚úì');
    }
    await renderServicios(nombre);
  } else {
    await renderServicios(nombre);
    toast('Ese servicio ya existe');
  }
};

$('#btnEliminarServicio').onclick = async ()=>{
  const current = f.servicio.value;
  if (!current) { toast('No hay servicio seleccionado'); return; }

  const actuales = await db.fetchServicios();
  if (!actuales.includes(current)) { toast('Ese servicio no est√° en la lista'); return; }

  if (!confirm(`¬øEliminar "${current}" de la lista de servicios?\n(No afecta a los clientes ya guardados).`)) return;

  const nueva = actuales.filter(s => s !== current);
  await db.replaceServicios(nueva);

  if (!currentUser) {
    toast('Servicio eliminado (local) ‚úì  Accede para guardar en la nube');
  } else {
    toast('Servicio eliminado ‚úì');
  }
  await renderServicios();
};

/* Mostrar/Ocultar PIN (form) */
const btnEye=document.getElementById('togglePin');
if(btnEye){ btnEye.addEventListener('click',()=>{ const isPass=f.pin.type==='password'; f.pin.type=isPass?'text':'password'; btnEye.textContent=isPass?'üôà':'üëÅ'; }); }

/* ===== Chat (Gemini) ===== */
const GEMINI_API_KEY = 'AIzaSyC9hpKbGmUx3_YcgVGI3AEOdKvWRSoU81k';
const GEMINI_MODEL  = 'gemini-1.5-flash';
const chatModal = document.getElementById('chatModal');
const btnChatOpen = document.getElementById('btnChatOpen');
const btnChatClose = document.getElementById('btnChatClose');
const chatLogEl = document.getElementById('chatLog');
const chatInputEl = document.getElementById('chatInput');
let chatHistory = JSON.parse(localStorage.getItem('chat_v1')||'[]');

function openChat(){ chatModal.classList.add('open'); chatModal.setAttribute('aria-hidden','false'); setTimeout(()=>chatInputEl?.focus(), 0); }
function closeChat(){ chatModal.classList.remove('open'); chatModal.setAttribute('aria-hidden','true'); }
btnChatOpen?.addEventListener('click', openChat);
btnChatClose?.addEventListener('click', closeChat);
chatModal?.addEventListener('click', (e)=>{ if(e.target===chatModal) closeChat(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeChat(); });

function renderChat(){
  if(!chatLogEl) return;
  chatLogEl.innerHTML = chatHistory
    .map(m=>`<div class="chat-msg ${m.role}"><div class="bubble">${esc(m.text)}</div></div>`)
    .join('');
  chatLogEl.scrollTop = chatLogEl.scrollHeight;
}
renderChat();

function normalize(s){return (s||'').toString().normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'').toLowerCase();}
function clientToSafe(rec, includeSecrets){
  const d = (function(iso){ if(!iso) return null; const h=new Date();h.setHours(0,0,0,0); const dd=new Date(iso); dd.setHours(0,0,0,0); return Math.round((dd-h)/(1000*60*60*24)); })(rec.vence);
  const est = rec.vence? (d<0?'vencida':(d<=7?'pronto':'vigente')) : '';
  const out = {
    id: rec.id,
    nombre: rec.nombre||'',
    email: rec.email||'',
    telefono: rec.telefono||'',
    servicio: rec.servicio||'',
    inicio: rec.inicio||'',
    vence: rec.vence||'',
    categoria: rec.categoria||'',
    estado: est,
    dias: d
  };
  if(includeSecrets){ if(rec.pin) out.pin = rec.pin; if(rec.notas) out.notas = rec.notas; }
  return out;
}
function buildPrompt(userMsg){
  const includeSecrets = document.getElementById('shareSecrets')?.checked || false;
  const textNorm = normalize(userMsg);
  const clientes = db.getAll();
  const enriched = clientes.map(r=>clientToSafe(r, includeSecrets));
  const matches = enriched.filter(r=>{
    const n=normalize(r.nombre), e=normalize(r.email), s=normalize(r.servicio);
    return (n && textNorm.includes(n)) || (e && textNorm.includes(e)) || (s && textNorm.includes(s));
  });
  const context = (matches.length? matches.slice(0,10) : enriched.slice(0,50));
  const guidance = [
    'Eres un asistente que habla espa√±ol y ayuda a gestionar clientes.',
    'Usa SOLO los datos proporcionados. Si algo no est√° en DATOS, di: "no est√° en mis registros".',
    'Si el usuario pide PIN y no existe el campo "pin" en los DATOS, responde brevemente que por seguridad no lo compartes a menos que el usuario habilite Compartir datos sensibles.',
    'Formatea las respuestas de ficha con etiquetas: Nombre, Email, Tel√©fono, Servicio, Inicio, Vence, Estado, D√≠as, Categor√≠a, Notas.'
  ];
  const prompt = [
    ...guidance,
    'DATOS(JSON):',
    JSON.stringify(context),
    `PREGUNTA: ${userMsg}`
  ].join('\n');
  return prompt;
}

async function requestGemini(prompt){
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
  const payload = { contents: [{ role:'user', parts:[{ text: prompt }]}] };
  const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const json = await res.json();
  return json?.candidates?.[0]?.content?.parts?.[0]?.text || '(sin respuesta)';
}

async function sendChat(){
  const text = (chatInputEl?.value||'').trim(); if(!text) return;
  chatHistory.push({ role:'user', text }); renderChat(); chatInputEl.value='';
  try{
    const reply = await requestGemini(buildPrompt(text));
    chatHistory.push({ role:'ai', text: reply });
    tryApplyToolFrom(reply, text);
  }catch(err){
    chatHistory.push({ role:'ai', text: `[Error al llamar a Gemini: ${err.message}]` });
  }
  localStorage.setItem('chat_v1', JSON.stringify(chatHistory));
  renderChat();
}

document.getElementById('btnSend')?.addEventListener('click', sendChat);
chatInputEl?.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }});

/* ==== Herramientas locales para aplicar cambios desde el chat ==== */
function parseDateToISO(s){
  if(!s) return s; s=String(s).trim();
  if(s.indexOf('-')>0) return s;
  if(s.indexOf('/')>0){ const parts=s.split('/'); if(parts.length===3){ const d=parts[0].padStart(2,'0'); const m=parts[1].padStart(2,'0'); const y=parts[2]; return `${y}-${m}-${d}`; } }
  return s;
}
function extractJson(text){
  const i = text.indexOf('```json'); if(i>=0){ const j = text.indexOf('```', i+7); if(j>i){ return text.slice(i+7, j).trim(); } }
  const a = text.indexOf('{'); const b = text.lastIndexOf('}');
  if(a>=0 && b>a) return text.slice(a,b+1);
  return null;
}
function tryApplyToolFrom(modelText, userText){
  const raw = extractJson(modelText); if(!raw) return false;
  let cmd; try{ cmd = JSON.parse(raw); }catch{ return false; }
  if(!cmd || cmd.action !== 'update_client' || !cmd.set) return false;
  return applyUpdateCommand(cmd);
}
function findClientByMatch(match){
  const arr = db.getAll(); const t = m=>normalize(m||'');
  let filtered = arr.filter(c=>{
    const okNombre = match?.nombre? t(c.nombre).includes(t(match.nombre)) : true;
    const okEmail  = match?.email?  t(c.email) === t(match.email) || t(c.email).includes(t(match.email)) : true;
    const okServ   = match?.servicio? t(c.servicio).includes(t(match.servicio)) : true;
    return okNombre && okEmail && okServ;
  });
  return filtered;
}
async function applyUpdateCommand(cmd){
  const matches = findClientByMatch(cmd.match||{});
  if(matches.length !== 1){
    const msg = matches.length===0? 'No encontr√© un cliente con esos datos. Especifica nombre o email.' : `Hay ${matches.length} clientes que coinciden. Especifica email para continuar.`;
    chatHistory.push({role:'ai', text: msg});
    renderChat();
    return false;
  }
  const client = matches[0];
  const allowed = {nombre:1,email:1,telefono:1,servicio:1,inicio:1,vence:1,categoria:1,notas:1,pin:1};
  const set = Object.assign({}, cmd.set);
  if(set.inicio) set.inicio = parseDateToISO(set.inicio);
  if(set.vence)  set.vence  = parseDateToISO(set.vence);

  const arr = db.getAll();
  const idx = arr.findIndex(x=>x.id===client.id);
  if(idx<0){ chatHistory.push({role:'ai', text:'Error interno: no se pudo ubicar el registro.'}); renderChat(); return false; }
  const before = Object.assign({}, arr[idx]);
  Object.keys(set).forEach(k=>{ if(allowed[k]) arr[idx][k] = set[k]; });

  await db.saveAll(arr);
  await renderTabla();

  const changed = Object.keys(set).map(k=>`${k}: "${before[k]||''}" ‚Üí "${arr[idx][k]}"`).join('\n');
  chatHistory.push({role:'ai', text:`Actualizado ‚úì\nCliente: ${arr[idx].nombre}\nCambios:\n${changed}`});
  renderChat();
  return true;
}

function formatDM(iso){ if(!iso) return ''; var d=new Date(iso+'T00:00:00'); return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0'); }
function buildEtiqueta(c){
  var svc=(c.servicio||'').toString().toUpperCase();
  var fv=formatDM(c.vence)||'--/--';
  var correo=c.email||'';
  var perfil=c.nombre||'';
  var pin=c.pin||'';
  var t='*'+svc+'* ‚ú® üìß‚ú® *FV: '+fv+'*\n';
  t+='*Correo:* '+correo+'\n';
  t+='*Contrase√±a:* '+'\n';
  t+='__________________'+'\n';
  t+='Perf√≠l:  '+perfil+'\n';
  t+='PIN:  '+pin+'\n';
  t+='__________________'+'\n';
  t+='üíªüì≤'+'\n';
  t+='    üåü Gracias por tu compra';
  return t;
}
async function copyToClipboard(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(e){ try{ var ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return true; }catch(_){ return false; } }
}
function etiquetar(id){
  var c=db.getAll().find(function(x){return x.id===id}); if(!c){ toast('Cliente no encontrado'); return; }
  var etiqueta = buildEtiqueta(c);
  copyToClipboard(etiqueta).then(function(ok){ toast(ok?'Etiqueta copiada ‚úì':'No se pudo copiar'); });
}

/* ===== DEV TESTS (ligeros) ===== */
(function(){
  function runTests(){
    const backupGet = db.getAll, backupSaveAll = db.saveAll;
    let mem = [{id:'1',nombre:'Ana',servicio:'ChatGPT',vence:'2025-10-01',pin:'1234',notas:'vip'}];
    db.getAll = () => JSON.parse(JSON.stringify(mem));
    db.saveAll = (x) => { mem = JSON.parse(JSON.stringify(x)); };

    console.assert(parseDateToISO('20/10/2025') === '2025-10-20','parseDateToISO convierte dd/mm/aaaa');
    applyUpdateCommand({action:'update_client', match:{nombre:'Ana'}, set:{vence:'2025-11-01'}});
    console.assert(mem[0].vence==='2025-11-01','applyUpdateCommand actualiza vence');

    db.getAll = backupGet; db.saveAll = backupSaveAll;
    console.log('[tests] OK');
  }
  try{ runTests(); }catch(e){ console.warn('[tests] fallo:', e); }
})();

/* inicio */
renderServicios().then(()=>renderTabla());
</script>
</body>
</html>
