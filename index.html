<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>A√±adir Cliente</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0f241a; --ink-soft:#334155; --muted:#64748b; --bg:#ffffff;
      --field:#f5f6f8; --field-focus:#ffffff; --border:#e6e7eb;
      --pill-bg:#edf7f1; --pill-ink:#19603a; --btn:#222426; --btn-ink:#ffffff;
      --ghost:#ffffff; --ghost-border:#dfe3e8; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    html,body{margin:0;background:var(--bg);color:var(--ink)}
    a{color:inherit}

    /* ===== Toolbar superior ===== */
    .toolbar{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.92);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border)}
    .toolbar-inner{max-width:980px;margin:0 auto;padding:10px 12px;display:flex;gap:8px;align-items:center}
    .toolbar input,.toolbar select{padding:10px 12px;border-radius:10px;border:1px solid var(--ghost-border);background:#fff;min-width:200px}
    .spacer{flex:1}
    .btn{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn.ghost{background:var(--ghost);border:1px solid var(--ghost-border);}
    .btn.primary{background:var(--btn);color:var(--btn-ink)}

    /* ===== Layout ===== */
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 60px}
    .pill{display:block;width:max-content;margin:0 auto 10px;padding:6px 12px;border-radius:999px;background:var(--pill-bg);color:var(--pill-ink);border:1px solid #cfe7d8;font-size:12px}
    h1{margin:6px 0 16px;text-align:center;font-weight:800;letter-spacing:-0.02em;color:var(--ink);font-size:clamp(36px,8vw,72px);line-height:1.02}

    /* ===== Servicio centrado ===== */
    .center{display:flex;justify-content:center;align-items:center;gap:10px;margin:8px 0 20px}
    .center .label{color:var(--ink-soft)}
    .addserv{border:1px dashed var(--border);background:#fff;padding:8px 10px;border-radius:10px;font-size:14px}

    /* ===== Form (labels arriba) ===== */
    .form{max-width:560px;margin:0 auto}
    .row{display:flex;flex-direction:column;gap:6px;margin-bottom:14px}
    .row label{color:var(--ink-soft);font-size:14px;font-weight:600}
    input,select,textarea{width:100%;padding:14px;border:1px solid var(--border);border-radius:14px;background:var(--field);outline:none;transition:.15s}
    input:focus,select:focus,textarea:focus{border-color:#cbd5e1;background:var(--field-focus);box-shadow:0 0 0 3px rgba(15, 23, 42, .05)}
    textarea{min-height:88px;resize:vertical}
    .actions{display:flex;justify-content:center;gap:10px;margin-top:18px}
    .small{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
    .pin-wrap{position:relative}
    .pin-wrap .eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:1px solid var(--ghost-border);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer}

    /* ===== Tabla ===== */
    table{width:100%;border-collapse:collapse;margin-top:26px}
    th,td{padding:12px;border-bottom:1px solid var(--border);font-size:14px}
    th{text-align:left;color:#334155}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;display:inline-block;border:1px solid}
    .tag.ok{color:#166534;background:#ecfdf5;border-color:#86efac}
    .tag.warn{color:#92400e;background:#fffbeb;border-color:#fde68a}
    .tag.bad{color:#7f1d1d;background:#fef2f2;border-color:#fecaca}

    /* ===== Kebab ‚ãØ men√∫ ===== */
    .menu-wrap{position:relative;display:inline-block}
    .kebab{border:1px solid var(--border);background:#fff;border-radius:12px;padding:6px 10px;cursor:pointer;line-height:1}
    .kebab .dots{letter-spacing:2px;font-size:18px;color:#64748b}
    .kebab:focus{outline:2px solid #cbd5e1}
    .menu{position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 28px rgba(2,6,23,.08);min-width:160px;padding:6px;display:none;z-index:50}
    .menu.open{display:block}
    .menu-item{display:block;width:100%;text-align:left;background:#fff;border:0;border-radius:8px;padding:9px 10px;cursor:pointer;font-size:14px}
    .menu-item:hover{background:#f3f4f6}
    .menu-item.danger{color:#7f1d1d;border:1px solid #fecaca}

    /* ===== Modal Chat ===== */
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;background:rgba(2,6,23,.45);z-index:100}
    .modal-backdrop.open{display:flex}
    .modal{background:#fff;border:1px solid var(--border);border-radius:16px;width:min(760px,96vw);max-height:90vh;display:flex;flex-direction:column}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .modal .body{padding:12px}

    /* ===== Chat (Gemini) dentro del modal ===== */
    .section-head{font-weight:700;margin-bottom:8px;color:var(--ink)}
    .chat-log{height:260px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:10px;background:#f9fafb}
    .chat-msg{margin:8px 0;display:flex}
    .chat-msg.user{justify-content:flex-end}
    .chat-msg .bubble{max-width:85%;padding:10px 12px;border-radius:12px;white-space:pre-wrap}
    .chat-msg.user .bubble{background:#111827;color:#fff;border:1px solid #0b1220}
    .chat-msg.ai .bubble{background:#fff;border:1px solid var(--border);color:#0b1f16}

    @media (max-width:680px){ .toolbar-inner{flex-wrap:wrap} }
  </style>
</head>
<body>
  <!-- toolbar -->
  <div class="toolbar">
    <div class="toolbar-inner">
      <input id="q" placeholder="Buscar por nombre, email o servicio‚Ä¶"/>
      <select id="filterEstado">
        <option value="">Todos</option>
        <option value="vigente">Vigentes</option>
        <option value="pronto">Por vencer (‚â§7 d√≠as)</option>
        <option value="vencida">Vencidas</option>
      </select>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnExportar">Exportar JSON</button>
      <label class="btn ghost">Importar JSON
        <input type="file" id="importFile" accept="application/json" hidden>
      </label>
      <!-- Reemplazo: se quita Borrar todo y se agrega Chat Gemini -->
      <button class="btn ghost" id="btnChatOpen" title="Abrir chat con Gemini">Chat Gemini</button>
    </div>
  </div>

  <div class="wrap">
    <span class="pill">importante</span>
    <h1>A√±adir Cliente</h1>

    <div class="center">
      <div class="label">Servicio</div>
      <select id="servicio" style="max-width:260px"></select>
      <button id="btnAgregarServicio" class="addserv">+ Servicio</button>
    </div>

    <div class="form">
      <div class="row">
        <label for="nombre">Nombre</label>
        <input id="nombre" placeholder="Escribe"/>
      </div>
      <div class="row">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="ej: cliente@mail.com"/>
      </div>
      <div class="row">
        <label for="telefono">Tel√©fono</label>
        <input id="telefono" placeholder="+51 ‚Ä¶"/>
      </div>
      <div class="row">
        <label for="inicio">Fecha</label>
        <input id="inicio" type="date" />
      </div>
      <div class="row">
        <label for="vence">Vence</label>
        <input id="vence" type="date" />
      </div>
      <div class="row">
        <label for="pin">PIN</label>
        <div class="pin-wrap">
          <input id="pin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          <button type="button" class="eye" id="togglePin" aria-label="Mostrar/ocultar PIN">üëÅ</button>
        </div>
      </div>
      <div class="row">
        <label for="categoria">Categor√≠a</label>
        <select id="categoria">
          <option value="">Selecciona una opci√≥n</option>
          <option>Premium</option>
          <option>Est√°ndar</option>
          <option>B√°sico</option>
        </select>
      </div>
      <div class="row">
        <label for="notas">Notas</label>
        <textarea id="notas" placeholder="Plan, precio, usuario, etc."></textarea>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnGuardar">Agregar</button>
        <button class="btn ghost" id="btnLimpiar">Limpiar</button>
      </div>
      <div class="small" id="msg"></div>
    </div>

    <!-- tabla -->
    <table id="tabla">
      <thead>
        <tr>
          <th>Nombre</th><th>Email</th><th>Servicio</th>
          <th>Inicio</th><th>Vence</th><th>Estado</th><th>D√≠as</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ===== Modal Chat Gemini (oculto por defecto) ===== -->
  <div id="chatModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Chat Gemini">
      <header>
        <strong>Chat Gemini</strong>
        <button class="btn ghost" id="btnChatClose">Cerrar</button>
      </header>
      <div class="body">
        <div id="chatLog" class="chat-log"></div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:10px">
          <input id="chatInput" placeholder="Escribe un mensaje‚Ä¶"/>
          <button class="btn primary" id="btnSend">Enviar</button>
        </div>
        <div class="small">Conexi√≥n directa a Gemini desde el navegador (API key expuesta).</div>
      </div>
    </div>
  </div>

<script>
/* ===== almacenamiento ===== */
const KEY='clientes_v6'; const KEY_SERVS='servicios_v6';
const db={
  getAll(){return JSON.parse(localStorage.getItem(KEY)||'[]')},
  saveAll(x){localStorage.setItem(KEY,JSON.stringify(x))},
  getServicios(){return JSON.parse(localStorage.getItem(KEY_SERVS)||'["ChatGPT","Gemini","YouTube","Disney"]')},
  saveServicios(x){localStorage.setItem(KEY_SERVS,JSON.stringify(x))}
};
/* ===== helpers ===== */
const $=s=>document.querySelector(s);
const tbody=$('#tabla tbody');
const f={nombre:$('#nombre'),email:$('#email'),telefono:$('#telefono'),
servicio:$('#servicio'),inicio:$('#inicio'),vence:$('#vence'),notas:$('#notas'),
categoria:$('#categoria'), pin:$('#pin')};
const q=$('#q'), filterEstado=$('#filterEstado'), msg=$('#msg');
let editId=null;

function renderServicios(){
  const list=db.getServicios();
  f.servicio.innerHTML=list.map(s=>`<option value="${s}">${s}</option>`).join('');
}
renderServicios();
$('#btnAgregarServicio').onclick=()=>{
  const nombre=prompt('Nombre del nuevo servicio:');
  if(!nombre) return;
  const list=db.getServicios();
  if(!list.includes(nombre)){ list.push(nombre); list.sort((a,b)=>a.localeCompare(b)); db.saveServicios(list); renderServicios(); f.servicio.value=nombre; toast('Servicio agregado ‚úì'); }
  else { f.servicio.value=nombre; toast('Servicio ya exist√≠a'); }
};

function diasRestantes(iso){
  if(!iso) return null; const h=new Date();h.setHours(0,0,0,0);
  const d=new Date(iso); d.setHours(0,0,0,0);
  return Math.round((d-h)/(1000*60*60*24));
}
function estadoDe(vence){
  if(!vence) return ''; const d=diasRestantes(vence);
  if(d<0) return 'vencida'; if(d<=7) return 'pronto'; return 'vigente';
}

function limpiar(){ editId=null; for(const k in f){ if('value' in f[k]) f[k].value=''; } renderServicios(); msg.textContent=''; }
$('#btnLimpiar').onclick=limpiar;

$('#btnGuardar').onclick=()=>{
  const data={ id:editId ?? crypto.randomUUID(),
    nombre:f.nombre.value.trim(), email:f.email.value.trim(), telefono:f.telefono.value.trim(),
    servicio:f.servicio.value, inicio:f.inicio.value, vence:f.vence.value,
    categoria:f.categoria.value, notas:f.notas.value.trim(), pin:f.pin.value.trim(), ts:Date.now()
  };
  if(!data.nombre){ toast('Escribe un nombre'); return; }
  const arr=db.getAll(); const i=arr.findIndex(x=>x.id===data.id);
  if(i>=0) arr[i]=data; else arr.push(data);
  arr.sort((a,b)=>a.nombre.localeCompare(b.nombre)); db.saveAll(arr);
  renderTabla(); limpiar(); toast('Guardado ‚úì');
};

function editar(id){
  const x=db.getAll().find(c=>c.id===id); if(!x) return; editId=x.id;
  for(const k in f){ if(k in x) f[k].value=x[k]||''; }
  msg.textContent='Editando‚Ä¶ guarda para aplicar cambios';
}
function borrar(id){
  if(!confirm('¬øEliminar este cliente?')) return;
  db.saveAll(db.getAll().filter(c=>c.id!==id)); renderTabla();
}

function coincide(x,qq){
  qq=(qq||'').trim().toLowerCase(); if(!qq) return true;
  return [x.nombre,x.email,x.servicio,x.telefono,x.categoria,x.notas]
    .some(v=>(v||'').toLowerCase().includes(qq));
}
function pasaEstado(x,f){ if(!f) return true; return estadoDe(x.vence)===f; }

function esc(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;' }[m]))}
function fmt(iso){return iso? new Date(iso+'T00:00:00').toLocaleDateString(): '-'}

function renderTabla(){
  const arr=db.getAll(); const items=arr.filter(x=>coincide(x,q?.value)&&pasaEstado(x,filterEstado?.value));
  tbody.innerHTML=items.map(x=>{
    const d=diasRestantes(x.vence); const est=estadoDe(x.vence);
    const tag=est==='vigente'?'ok':est==='pronto'?'warn':'bad';
    const estTxt=est?est[0].toUpperCase()+est.slice(1):'-';
    const diasTxt= d==null?'-':(d<0?`Vencido ${Math.abs(d)} d`:`Faltan ${d} d`);
    return `<tr>
      <td>${esc(x.nombre)}</td>
      <td>${esc(x.email||'')}</td>
      <td>${esc(x.servicio||'')}</td>
      <td>${fmt(x.inicio)}</td>
      <td>${fmt(x.vence)}</td>
      <td>${est?`<span class="tag ${tag}">${estTxt}</span>`:'-'}</td>
      <td>${diasTxt}</td>
      <td style="text-align:right">
        <div class="menu-wrap">
          <button class="kebab" aria-haspopup="menu" aria-expanded="false"><span class="dots">‚ãØ</span></button>
          <div class="menu" role="menu">
            <button class="menu-item" role="menuitem" data-action="edit" data-id="${x.id}">‚úé Editar</button>
            <button class="menu-item danger" role="menuitem" data-action="delete" data-id="${x.id}">üóë Eliminar</button>
          </div>
        </div>
      </td>
    </tr>`;
  }).join('');
}
renderTabla();

/* kebab: abrir/cerrar y acciones */
document.addEventListener('click', (e)=>{
  const wrap=e.target.closest('.menu-wrap');
  const isKebab=e.target.closest('.kebab');
  const item=e.target.closest('.menu-item');

  if(!wrap && !item){
    document.querySelectorAll('.menu.open').forEach(m=>{ m.classList.remove('open'); m.previousElementSibling?.setAttribute('aria-expanded','false');});
  }
  if(isKebab){
    const menu=isKebab.nextElementSibling;
    document.querySelectorAll('.menu.open').forEach(m=>{ if(m!==menu){ m.classList.remove('open'); m.previousElementSibling?.setAttribute('aria-expanded','false');}});
    const isOpen=menu.classList.toggle('open');
    isKebab.setAttribute('aria-expanded', isOpen?'true':'false');
  }
  if(item){
    const id=item.dataset.id;
    if(item.dataset.action==='edit') editar(id);
    if(item.dataset.action==='delete') borrar(id);
    document.querySelectorAll('.menu.open').forEach(m=>{ m.classList.remove('open'); m.previousElementSibling?.setAttribute('aria-expanded','false');});
  }
});
document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){
    document.querySelectorAll('.menu.open').forEach(m=>{ m.classList.remove('open'); m.previousElementSibling?.setAttribute('aria-expanded','false');});
  }
});

/* Exportar / Importar */
const btnExp=document.getElementById('btnExportar'); if(btnExp){ btnExp.onclick=()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(db.getAll(),null,2)],{type:'application/json'})); a.download='clientes.json'; a.click(); }; }
const inputImp=document.getElementById('importFile'); if(inputImp){ inputImp.onchange=async e=>{ const file=e.target.files[0]; if(!file) return; try{ const txt=await file.text(); const data=JSON.parse(txt); if(!Array.isArray(data)) throw 0; db.saveAll(data); renderTabla(); toast('Importado ‚úì'); }catch{ alert('Archivo no v√°lido'); } e.target.value=''; }; }

/* Mostrar/Ocultar PIN */
const btnEye=document.getElementById('togglePin');
if(btnEye){ btnEye.addEventListener('click',()=>{ const isPass=f.pin.type==='password'; f.pin.type=isPass?'text':'password'; btnEye.textContent=isPass?'üôà':'üëÅ'; }); }

function toast(t){ msg.textContent=t; setTimeout(()=>msg.textContent='',2200); }

/* ===== Chat (Gemini) ===== */
const GEMINI_API_KEY = 'AIzaSyC9hpKbGmUx3_YcgVGI3AEOdKvWRSoU81k'; // visible en el navegador
const GEMINI_MODEL  = 'gemini-1.5-flash';
const chatModal = document.getElementById('chatModal');
const btnChatOpen = document.getElementById('btnChatOpen');
const btnChatClose = document.getElementById('btnChatClose');
const chatLogEl = document.getElementById('chatLog');
const chatInputEl = document.getElementById('chatInput');
let chatHistory = JSON.parse(localStorage.getItem('chat_v1')||'[]');

function openChat(){ chatModal.classList.add('open'); chatModal.setAttribute('aria-hidden','false'); setTimeout(()=>chatInputEl?.focus(), 0); }
function closeChat(){ chatModal.classList.remove('open'); chatModal.setAttribute('aria-hidden','true'); }
btnChatOpen?.addEventListener('click', openChat);
btnChatClose?.addEventListener('click', closeChat);
chatModal?.addEventListener('click', (e)=>{ if(e.target===chatModal) closeChat(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeChat(); });

function renderChat(){
  if(!chatLogEl) return;
  chatLogEl.innerHTML = chatHistory
    .map(m=>`<div class="chat-msg ${m.role}"><div class="bubble">${esc(m.text)}</div></div>`)
    .join('');
  chatLogEl.scrollTop = chatLogEl.scrollHeight;
}
renderChat();

function buildPrompt(userMsg){
  const clientes = db.getAll();
  const resumen = clientes.slice(0,50)
    .map(c=>`${c.nombre||'-'} | ${c.servicio||'-'} | vence ${c.vence||'-'}`)
    .join('\n');
  const prompt = [
    'Eres un asistente que habla espa√±ol y ayuda a gestionar clientes.',
    'Usa el contexto si es relevante y no inventes datos.',
    'Contexto (resumen):',
    resumen,
    '---',
    `Usuario: ${userMsg}`
  ].join('\n');
  return prompt;
}

async function requestGemini(prompt){
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
  const payload = { contents: [{ role:'user', parts:[{ text: prompt }]}] };
  const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const json = await res.json();
  return json?.candidates?.[0]?.content?.parts?.[0]?.text || '(sin respuesta)';
}

async function sendChat(){
  const text = (chatInputEl?.value||'').trim(); if(!text) return;
  chatHistory.push({ role:'user', text }); renderChat(); chatInputEl.value='';
  try{
    const reply = await requestGemini(buildPrompt(text));
    chatHistory.push({ role:'ai', text: reply });
  }catch(err){
    chatHistory.push({ role:'ai', text: `[Error al llamar a Gemini: ${err.message}]` });
  }
  localStorage.setItem('chat_v1', JSON.stringify(chatHistory));
  renderChat();
}

document.getElementById('btnSend')?.addEventListener('click', sendChat);
chatInputEl?.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }});

/* ===== DEV TESTS (para depurar buildPrompt) ===== */
(function(){
  function runTests(){
    const backup = db.getAll;
    db.getAll = () => ([{nombre:'Ana',servicio:'ChatGPT',vence:'2025-10-01'}]);
    const p = buildPrompt('Hola');
    console.assert(p.includes('Ana | ChatGPT | vence 2025-10-01'), 'El resumen no contiene a Ana');
    console.assert(p.split('\n').length >= 5, 'Se esperan varias l√≠neas en el prompt');
    db.getAll = backup;
    console.log('[tests] buildPrompt OK');
  }
  // Ejecuta autom√°ticamente; comenta la l√≠nea siguiente si no quieres logs en consola
  try{ runTests(); }catch(e){ console.warn('[tests] fallo:', e); }
})();
</script>
</body>
</html>
